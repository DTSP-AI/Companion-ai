"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/chat/[chatId]/route";
exports.ids = ["app/api/chat/[chatId]/route"];
exports.modules = {

/***/ "@prisma/client":
/*!*********************************!*\
  !*** external "@prisma/client" ***!
  \*********************************/
/***/ ((module) => {

module.exports = require("@prisma/client");

/***/ }),

/***/ "@prisma/client/scripts/default-index.js":
/*!**********************************************************!*\
  !*** external "@prisma/client/scripts/default-index.js" ***!
  \**********************************************************/
/***/ ((module) => {

module.exports = require("@prisma/client/scripts/default-index.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

module.exports = require("https");

/***/ }),

/***/ "node:crypto":
/*!******************************!*\
  !*** external "node:crypto" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:crypto");

/***/ }),

/***/ "node:fs":
/*!**************************!*\
  !*** external "node:fs" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("node:fs");

/***/ }),

/***/ "node:fs/promises":
/*!***********************************!*\
  !*** external "node:fs/promises" ***!
  \***********************************/
/***/ ((module) => {

module.exports = require("node:fs/promises");

/***/ }),

/***/ "node:https":
/*!*****************************!*\
  !*** external "node:https" ***!
  \*****************************/
/***/ ((module) => {

module.exports = require("node:https");

/***/ }),

/***/ "node:path":
/*!****************************!*\
  !*** external "node:path" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("node:path");

/***/ }),

/***/ "node:stream":
/*!******************************!*\
  !*** external "node:stream" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:stream");

/***/ }),

/***/ "os":
/*!*********************!*\
  !*** external "os" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("os");

/***/ }),

/***/ "path":
/*!***********************!*\
  !*** external "path" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("path");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("stream");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("url");

/***/ }),

/***/ "util":
/*!***********************!*\
  !*** external "util" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("util");

/***/ }),

/***/ "worker_threads":
/*!*********************************!*\
  !*** external "worker_threads" ***!
  \*********************************/
/***/ ((module) => {

module.exports = require("worker_threads");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("zlib");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2F%5BchatId%5D%2Froute&page=%2Fapi%2Fchat%2F%5BchatId%5D%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2F%5BchatId%5D%2Froute.ts&appDir=C%3A%5CAI_src%5CCompanion_UI%5CSaaS-AI-Companion%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CAI_src%5CCompanion_UI%5CSaaS-AI-Companion&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!*******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2F%5BchatId%5D%2Froute&page=%2Fapi%2Fchat%2F%5BchatId%5D%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2F%5BchatId%5D%2Froute.ts&appDir=C%3A%5CAI_src%5CCompanion_UI%5CSaaS-AI-Companion%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CAI_src%5CCompanion_UI%5CSaaS-AI-Companion&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \*******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var C_AI_src_Companion_UI_SaaS_AI_Companion_src_app_api_chat_chatId_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./src/app/api/chat/[chatId]/route.ts */ \"(rsc)/./src/app/api/chat/[chatId]/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/chat/[chatId]/route\",\n        pathname: \"/api/chat/[chatId]\",\n        filename: \"route\",\n        bundlePath: \"app/api/chat/[chatId]/route\"\n    },\n    resolvedPagePath: \"C:\\\\AI_src\\\\Companion_UI\\\\SaaS-AI-Companion\\\\src\\\\app\\\\api\\\\chat\\\\[chatId]\\\\route.ts\",\n    nextConfigOutput,\n    userland: C_AI_src_Companion_UI_SaaS_AI_Companion_src_app_api_chat_chatId_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/chat/[chatId]/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZjaGF0JTJGJTVCY2hhdElkJTVEJTJGcm91dGUmcGFnZT0lMkZhcGklMkZjaGF0JTJGJTVCY2hhdElkJTVEJTJGcm91dGUmYXBwUGF0aHM9JnBhZ2VQYXRoPXByaXZhdGUtbmV4dC1hcHAtZGlyJTJGYXBpJTJGY2hhdCUyRiU1QmNoYXRJZCU1RCUyRnJvdXRlLnRzJmFwcERpcj1DJTNBJTVDQUlfc3JjJTVDQ29tcGFuaW9uX1VJJTVDU2FhUy1BSS1Db21wYW5pb24lNUNzcmMlNUNhcHAmcGFnZUV4dGVuc2lvbnM9dHN4JnBhZ2VFeHRlbnNpb25zPXRzJnBhZ2VFeHRlbnNpb25zPWpzeCZwYWdlRXh0ZW5zaW9ucz1qcyZyb290RGlyPUMlM0ElNUNBSV9zcmMlNUNDb21wYW5pb25fVUklNUNTYWFTLUFJLUNvbXBhbmlvbiZpc0Rldj10cnVlJnRzY29uZmlnUGF0aD10c2NvbmZpZy5qc29uJmJhc2VQYXRoPSZhc3NldFByZWZpeD0mbmV4dENvbmZpZ091dHB1dD0mcHJlZmVycmVkUmVnaW9uPSZtaWRkbGV3YXJlQ29uZmlnPWUzMCUzRCEiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQXNHO0FBQ3ZDO0FBQ2M7QUFDb0M7QUFDakg7QUFDQTtBQUNBO0FBQ0Esd0JBQXdCLGdIQUFtQjtBQUMzQztBQUNBLGNBQWMseUVBQVM7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLFlBQVk7QUFDWixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0EsUUFBUSxpRUFBaUU7QUFDekU7QUFDQTtBQUNBLFdBQVcsNEVBQVc7QUFDdEI7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUN1SDs7QUFFdkgiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9haS1jb21wYW5pb24vPzY2MTkiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwUm91dGVSb3V0ZU1vZHVsZSB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1tb2R1bGVzL2FwcC1yb3V0ZS9tb2R1bGUuY29tcGlsZWRcIjtcbmltcG9ydCB7IFJvdXRlS2luZCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1raW5kXCI7XG5pbXBvcnQgeyBwYXRjaEZldGNoIGFzIF9wYXRjaEZldGNoIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvbGliL3BhdGNoLWZldGNoXCI7XG5pbXBvcnQgKiBhcyB1c2VybGFuZCBmcm9tIFwiQzpcXFxcQUlfc3JjXFxcXENvbXBhbmlvbl9VSVxcXFxTYWFTLUFJLUNvbXBhbmlvblxcXFxzcmNcXFxcYXBwXFxcXGFwaVxcXFxjaGF0XFxcXFtjaGF0SWRdXFxcXHJvdXRlLnRzXCI7XG4vLyBXZSBpbmplY3QgdGhlIG5leHRDb25maWdPdXRwdXQgaGVyZSBzbyB0aGF0IHdlIGNhbiB1c2UgdGhlbSBpbiB0aGUgcm91dGVcbi8vIG1vZHVsZS5cbmNvbnN0IG5leHRDb25maWdPdXRwdXQgPSBcIlwiXG5jb25zdCByb3V0ZU1vZHVsZSA9IG5ldyBBcHBSb3V0ZVJvdXRlTW9kdWxlKHtcbiAgICBkZWZpbml0aW9uOiB7XG4gICAgICAgIGtpbmQ6IFJvdXRlS2luZC5BUFBfUk9VVEUsXG4gICAgICAgIHBhZ2U6IFwiL2FwaS9jaGF0L1tjaGF0SWRdL3JvdXRlXCIsXG4gICAgICAgIHBhdGhuYW1lOiBcIi9hcGkvY2hhdC9bY2hhdElkXVwiLFxuICAgICAgICBmaWxlbmFtZTogXCJyb3V0ZVwiLFxuICAgICAgICBidW5kbGVQYXRoOiBcImFwcC9hcGkvY2hhdC9bY2hhdElkXS9yb3V0ZVwiXG4gICAgfSxcbiAgICByZXNvbHZlZFBhZ2VQYXRoOiBcIkM6XFxcXEFJX3NyY1xcXFxDb21wYW5pb25fVUlcXFxcU2FhUy1BSS1Db21wYW5pb25cXFxcc3JjXFxcXGFwcFxcXFxhcGlcXFxcY2hhdFxcXFxbY2hhdElkXVxcXFxyb3V0ZS50c1wiLFxuICAgIG5leHRDb25maWdPdXRwdXQsXG4gICAgdXNlcmxhbmRcbn0pO1xuLy8gUHVsbCBvdXQgdGhlIGV4cG9ydHMgdGhhdCB3ZSBuZWVkIHRvIGV4cG9zZSBmcm9tIHRoZSBtb2R1bGUuIFRoaXMgc2hvdWxkXG4vLyBiZSBlbGltaW5hdGVkIHdoZW4gd2UndmUgbW92ZWQgdGhlIG90aGVyIHJvdXRlcyB0byB0aGUgbmV3IGZvcm1hdC4gVGhlc2Vcbi8vIGFyZSB1c2VkIHRvIGhvb2sgaW50byB0aGUgcm91dGUuXG5jb25zdCB7IHJlcXVlc3RBc3luY1N0b3JhZ2UsIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzIH0gPSByb3V0ZU1vZHVsZTtcbmNvbnN0IG9yaWdpbmFsUGF0aG5hbWUgPSBcIi9hcGkvY2hhdC9bY2hhdElkXS9yb3V0ZVwiO1xuZnVuY3Rpb24gcGF0Y2hGZXRjaCgpIHtcbiAgICByZXR1cm4gX3BhdGNoRmV0Y2goe1xuICAgICAgICBzZXJ2ZXJIb29rcyxcbiAgICAgICAgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZVxuICAgIH0pO1xufVxuZXhwb3J0IHsgcm91dGVNb2R1bGUsIHJlcXVlc3RBc3luY1N0b3JhZ2UsIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzLCBvcmlnaW5hbFBhdGhuYW1lLCBwYXRjaEZldGNoLCAgfTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YXBwLXJvdXRlLmpzLm1hcCJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2F%5BchatId%5D%2Froute&page=%2Fapi%2Fchat%2F%5BchatId%5D%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2F%5BchatId%5D%2Froute.ts&appDir=C%3A%5CAI_src%5CCompanion_UI%5CSaaS-AI-Companion%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CAI_src%5CCompanion_UI%5CSaaS-AI-Companion&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./src/app/api/chat/[chatId]/route.ts":
/*!********************************************!*\
  !*** ./src/app/api/chat/[chatId]/route.ts ***!
  \********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var _clerk_nextjs_server__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! @clerk/nextjs/server */ \"(rsc)/./node_modules/@clerk/nextjs/dist/esm/server/createGetAuth.js\");\n/* harmony import */ var _langchain_openai__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @langchain/openai */ \"(rsc)/./node_modules/@langchain/openai/index.js\");\n/* harmony import */ var langchain_chains__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! langchain/chains */ \"(rsc)/./node_modules/langchain/chains.js\");\n/* harmony import */ var _langchain_core_prompts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @langchain/core/prompts */ \"(rsc)/./node_modules/@langchain/core/prompts.js\");\n/* harmony import */ var _lib_memory__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! @/lib/memory */ \"(rsc)/./src/lib/memory.ts\");\n/* harmony import */ var _lib_prismadb__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! @/lib/prismadb */ \"(rsc)/./src/lib/prismadb.ts\");\n/* harmony import */ var _lib_rate_limit__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! @/lib/rate-limit */ \"(rsc)/./src/lib/rate-limit.ts\");\n\n\n\n\n\n\n\n\nconsole.log(\"\\uD83D\\uDD27 [DEBUG] API route loaded\");\nconsole.log(\"\\uD83D\\uDD27 [DEBUG] Process environment variables:\");\nconsole.log(\"\\uD83D\\uDD27 [DEBUG] OPENAI_API_KEY is\", process.env.OPENAI_API_KEY ? \"set\" : \"NOT set\");\nconst conversationChains = new Map();\nconst getCharacterDescription = (description)=>{\n    console.log(\"\\uD83D\\uDD27 [DEBUG] Entered getCharacterDescription()\");\n    console.log(\"\\uD83D\\uDD0D [getCharacterDescription] Processing character description\");\n    const result = description ? JSON.stringify(description) : \"No character description provided.\";\n    console.log(`📝 [getCharacterDescription] Result: ${result.substring(0, 50)}...`);\n    console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting getCharacterDescription()\");\n    return result;\n};\nconst createConversationChain = (characterDescription, bufferMemory)=>{\n    console.log(\"\\uD83D\\uDD27 [DEBUG] Entered createConversationChain()\");\n    if (!process.env.OPENAI_API_KEY) {\n        console.error(\"❌ [ERROR] OPENAI_API_KEY is not set in environment variables\");\n        throw new Error(\"OPENAI_API_KEY is not set\");\n    } else {\n        console.log(\"✅ [INFO] OPENAI_API_KEY is set\");\n    }\n    console.log(\"\\uD83D\\uDD17 [CREATE_CHAIN] Creating new conversation chain\");\n    const llm = new _langchain_openai__WEBPACK_IMPORTED_MODULE_1__.ChatOpenAI({\n        modelName: \"gpt-4\",\n        temperature: 0.9,\n        openAIApiKey: process.env.OPENAI_API_KEY\n    });\n    console.log(`🤖 [CREATE_CHAIN] LLM created with model: ${llm.modelName}`);\n    const prompt = _langchain_core_prompts__WEBPACK_IMPORTED_MODULE_3__.ChatPromptTemplate.fromMessages([\n        _langchain_core_prompts__WEBPACK_IMPORTED_MODULE_3__.SystemMessagePromptTemplate.fromTemplate(characterDescription),\n        new _langchain_core_prompts__WEBPACK_IMPORTED_MODULE_3__.MessagesPlaceholder(\"shortTermHistory\"),\n        _langchain_core_prompts__WEBPACK_IMPORTED_MODULE_3__.HumanMessagePromptTemplate.fromTemplate(\"{input}\")\n    ]);\n    console.log(\"\\uD83D\\uDCDD [CREATE_CHAIN] Prompt template created\");\n    const chain = new langchain_chains__WEBPACK_IMPORTED_MODULE_2__.ConversationChain({\n        prompt: prompt,\n        llm: llm,\n        memory: bufferMemory,\n        verbose: true\n    });\n    console.log(\"✅ [CREATE_CHAIN] Conversation chain created successfully\");\n    console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting createConversationChain()\");\n    return chain;\n};\nasync function POST(req, { params }) {\n    console.log(\"\\uD83D\\uDE80 [POST] Starting POST request handling for chatId:\", params.chatId);\n    try {\n        // Parse the request body\n        const { prompt } = await req.json();\n        console.log(`📥 [POST] Received prompt: \"${prompt}\"`);\n        // Get user ID\n        const { userId } = (0,_clerk_nextjs_server__WEBPACK_IMPORTED_MODULE_7__.getAuth)(req);\n        console.log(`👤 [POST] User ID: ${userId}`);\n        if (!userId) {\n            console.log(\"\\uD83D\\uDEAB [POST] Unauthorized access attempt\");\n            return new next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse(\"Unauthorized\", {\n                status: 401\n            });\n        }\n        // Rate limiting\n        const { success } = await (0,_lib_rate_limit__WEBPACK_IMPORTED_MODULE_6__.rateLimit)(req);\n        console.log(`🚦 [POST] Rate limit check result: ${success}`);\n        if (!success) {\n            console.log(\"\\uD83D\\uDED1 [POST] Rate limit exceeded\");\n            return new next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse(\"Rate limit exceeded\", {\n                status: 429\n            });\n        }\n        // Fetch companion data\n        console.log(`🔍 [POST] Fetching companion data for chatId: ${params.chatId}`);\n        const companion = await _lib_prismadb__WEBPACK_IMPORTED_MODULE_5__[\"default\"].companion.findUnique({\n            where: {\n                id: params.chatId\n            },\n            include: {\n                messages: true\n            }\n        });\n        if (!companion) {\n            console.log(\"❌ [POST] Companion not found\");\n            return new next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse(\"Companion not found\", {\n                status: 404\n            });\n        }\n        console.log(`✅ [POST] Companion found: ${companion.id}`);\n        // Process character description\n        const characterDescription = getCharacterDescription(companion.characterDescription);\n        console.log(`📝 [POST] Character description processed`);\n        // Initialize MemoryManager\n        console.log(\"\\uD83E\\uDDE0 [POST] Initializing MemoryManager\");\n        const memoryManager = await _lib_memory__WEBPACK_IMPORTED_MODULE_4__.MemoryManager.getInstance();\n        const companionKey = {\n            companionId: companion.id,\n            userId: userId\n        };\n        console.log(`🔑 [POST] CompanionKey created: ${JSON.stringify(companionKey)}`);\n        // Create or reuse conversation chain\n        let chain = conversationChains.get(params.chatId);\n        if (!chain) {\n            console.log(\"\\uD83C\\uDD95 [POST] Creating new conversation chain\");\n            const { bufferMemory } = await memoryManager.getMemoryManager(companionKey);\n            console.log(\"\\uD83D\\uDD27 [DEBUG] Obtained bufferMemory from MemoryManager\");\n            chain = createConversationChain(characterDescription, bufferMemory);\n            conversationChains.set(params.chatId, chain);\n            console.log(\"✅ [POST] New conversation chain created and stored\");\n        } else {\n            console.log(\"♻️ [POST] Reusing existing conversation chain\");\n        }\n        // Determine if long-term memory should be used\n        const messageCount = companion.messages.length;\n        console.log(`📊 [POST] Total message count: ${messageCount}`);\n        let relevantMemories = [];\n        if (messageCount >= 10) {\n            console.log(\"\\uD83D\\uDD0D [POST] Retrieving relevant long-term memories\");\n            relevantMemories = await memoryManager.getRelevantMemories(companionKey, prompt);\n            console.log(`📚 [POST] Retrieved ${relevantMemories.length} relevant memories`);\n        } else {\n            console.log(\"\\uD83D\\uDD0D [POST] Skipping long-term memory retrieval as message count is less than 10\");\n        }\n        // Generate AI response\n        console.log(\"\\uD83D\\uDCAC [POST] Generating AI response with prompt:\", prompt);\n        console.log(\"\\uD83D\\uDD27 [DEBUG] About to call chain.call()\");\n        const response = await chain.call({\n            input: prompt,\n            longTermHistory: relevantMemories.join(\"\\n\") || \"\"\n        });\n        console.log(\"\\uD83D\\uDD27 [DEBUG] Received response from chain.call()\");\n        const aiMessage = response.response.trim();\n        console.log(`🤖 [POST] AI response generated: \"${aiMessage}\"`);\n        // Store user message in database\n        console.log(\"\\uD83D\\uDCBE [POST] Storing user message in database\");\n        await _lib_prismadb__WEBPACK_IMPORTED_MODULE_5__[\"default\"].message.create({\n            data: {\n                content: prompt,\n                role: \"user\",\n                userId: userId,\n                companionId: companion.id\n            }\n        });\n        // Store AI response in database\n        console.log(\"\\uD83D\\uDCBE [POST] Storing AI response in database\");\n        await _lib_prismadb__WEBPACK_IMPORTED_MODULE_5__[\"default\"].message.create({\n            data: {\n                content: aiMessage,\n                role: \"system\",\n                userId: userId,\n                companionId: companion.id\n            }\n        });\n        // Update the agent memory with the latest conversation\n        if (messageCount >= 10) {\n            console.log(\"\\uD83E\\uDDE0 [POST] Updating agent memory with latest conversation\");\n            await memoryManager.updateAgentMemory(companionKey, prompt, aiMessage);\n            console.log(\"✅ [POST] Agent memory updated\");\n        } else {\n            console.log(\"\\uD83E\\uDDE0 [POST] Skipping agent memory update as message count is less than 10\");\n        }\n        console.log(\"\\uD83C\\uDFC1 [POST] Request handling completed successfully\");\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            systemMessage: aiMessage\n        });\n    } catch (error) {\n        console.error(\"❌ [POST_ERROR] An error occurred during request processing:\");\n        if (error instanceof Error) {\n            console.error(`Error name: ${error.name}`);\n            console.error(`Error message: ${error.message}`);\n            console.error(`Error stack: ${error.stack}`);\n        } else {\n            console.error(\"Error details:\", JSON.stringify(error, null, 2));\n        }\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: \"An unexpected error occurred\",\n            details: error instanceof Error ? error.message : \"Unknown error\"\n        }, {\n            status: 500\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvYXBwL2FwaS9jaGF0L1tjaGF0SWRdL3JvdXRlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUF3RDtBQUNUO0FBQ0E7QUFDTTtBQU1wQjtBQUMwQjtBQUNyQjtBQUNPO0FBRTdDVyxRQUFRQyxHQUFHLENBQUM7QUFDWkQsUUFBUUMsR0FBRyxDQUFDO0FBQ1pELFFBQVFDLEdBQUcsQ0FDVCwwQ0FDQUMsUUFBUUMsR0FBRyxDQUFDQyxjQUFjLEdBQUcsUUFBUTtBQUd2QyxNQUFNQyxxQkFBcUIsSUFBSUM7QUFFL0IsTUFBTUMsMEJBQTBCLENBQUNDO0lBQy9CUixRQUFRQyxHQUFHLENBQUM7SUFDWkQsUUFBUUMsR0FBRyxDQUFDO0lBQ1osTUFBTVEsU0FBU0QsY0FDWEUsS0FBS0MsU0FBUyxDQUFDSCxlQUNmO0lBQ0pSLFFBQVFDLEdBQUcsQ0FDVCxDQUFDLHFDQUFxQyxFQUFFUSxPQUFPRyxTQUFTLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUV0RVosUUFBUUMsR0FBRyxDQUFDO0lBQ1osT0FBT1E7QUFDVDtBQUVBLE1BQU1JLDBCQUEwQixDQUM5QkMsc0JBQ0FDO0lBRUFmLFFBQVFDLEdBQUcsQ0FBQztJQUVaLElBQUksQ0FBQ0MsUUFBUUMsR0FBRyxDQUFDQyxjQUFjLEVBQUU7UUFDL0JKLFFBQVFnQixLQUFLLENBQUM7UUFDZCxNQUFNLElBQUlDLE1BQU07SUFDbEIsT0FBTztRQUNMakIsUUFBUUMsR0FBRyxDQUFDO0lBQ2Q7SUFFQUQsUUFBUUMsR0FBRyxDQUFDO0lBQ1osTUFBTWlCLE1BQU0sSUFBSTNCLHlEQUFVQSxDQUFDO1FBQ3pCNEIsV0FBVztRQUNYQyxhQUFhO1FBQ2JDLGNBQWNuQixRQUFRQyxHQUFHLENBQUNDLGNBQWM7SUFDMUM7SUFDQUosUUFBUUMsR0FBRyxDQUFDLENBQUMsMENBQTBDLEVBQUVpQixJQUFJQyxTQUFTLENBQUMsQ0FBQztJQUV4RSxNQUFNRyxTQUFTN0IsdUVBQWtCQSxDQUFDOEIsWUFBWSxD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UUFBUTtRQUNWO0lBRUo7QUFDRiIsInNvdXJjZXMiOlsid2VicGFjazovL2FpLWNvbXBhbmlvbi8uL3NyYy9hcHAvYXBpL2NoYXQvW2NoYXRJZF0vcm91dGUudHM/OTIxMCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZXh0UmVxdWVzdCwgTmV4dFJlc3BvbnNlIH0gZnJvbSBcIm5leHQvc2VydmVyXCI7XHJcbmltcG9ydCB7IGdldEF1dGggfSBmcm9tIFwiQGNsZXJrL25leHRqcy9zZXJ2ZXJcIjtcclxuaW1wb3J0IHsgQ2hhdE9wZW5BSSB9IGZyb20gXCJAbGFuZ2NoYWluL29wZW5haVwiO1xyXG5pbXBvcnQgeyBDb252ZXJzYXRpb25DaGFpbiB9IGZyb20gXCJsYW5nY2hhaW4vY2hhaW5zXCI7XHJcbmltcG9ydCB7XHJcbiAgQ2hhdFByb21wdFRlbXBsYXRlLFxyXG4gIEh1bWFuTWVzc2FnZVByb21wdFRlbXBsYXRlLFxyXG4gIFN5c3RlbU1lc3NhZ2VQcm9tcHRUZW1wbGF0ZSxcclxuICBNZXNzYWdlc1BsYWNlaG9sZGVyLFxyXG59IGZyb20gXCJAbGFuZ2NoYWluL2NvcmUvcHJvbXB0c1wiO1xyXG5pbXBvcnQgeyBNZW1vcnlNYW5hZ2VyLCBDb21wYW5pb25LZXkgfSBmcm9tIFwiQC9saWIvbWVtb3J5XCI7XHJcbmltcG9ydCBwcmlzbWFkYiBmcm9tIFwiQC9saWIvcHJpc21hZGJcIjtcclxuaW1wb3J0IHsgcmF0ZUxpbWl0IH0gZnJvbSBcIkAvbGliL3JhdGUtbGltaXRcIjtcclxuXHJcbmNvbnNvbGUubG9nKFwi8J+UpyBbREVCVUddIEFQSSByb3V0ZSBsb2FkZWRcIik7XHJcbmNvbnNvbGUubG9nKFwi8J+UpyBbREVCVUddIFByb2Nlc3MgZW52aXJvbm1lbnQgdmFyaWFibGVzOlwiKTtcclxuY29uc29sZS5sb2coXHJcbiAgXCLwn5SnIFtERUJVR10gT1BFTkFJX0FQSV9LRVkgaXNcIixcclxuICBwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWSA/IFwic2V0XCIgOiBcIk5PVCBzZXRcIlxyXG4pO1xyXG5cclxuY29uc3QgY29udmVyc2F0aW9uQ2hhaW5zID0gbmV3IE1hcDxzdHJpbmcsIENvbnZlcnNhdGlvbkNoYWluPigpO1xyXG5cclxuY29uc3QgZ2V0Q2hhcmFjdGVyRGVzY3JpcHRpb24gPSAoZGVzY3JpcHRpb246IGFueSk6IHN0cmluZyA9PiB7XHJcbiAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gRW50ZXJlZCBnZXRDaGFyYWN0ZXJEZXNjcmlwdGlvbigpXCIpO1xyXG4gIGNvbnNvbGUubG9nKFwi8J+UjSBbZ2V0Q2hhcmFjdGVyRGVzY3JpcHRpb25dIFByb2Nlc3NpbmcgY2hhcmFjdGVyIGRlc2NyaXB0aW9uXCIpO1xyXG4gIGNvbnN0IHJlc3VsdCA9IGRlc2NyaXB0aW9uXHJcbiAgICA/IEpTT04uc3RyaW5naWZ5KGRlc2NyaXB0aW9uKVxyXG4gICAgOiBcIk5vIGNoYXJhY3RlciBkZXNjcmlwdGlvbiBwcm92aWRlZC5cIjtcclxuICBjb25zb2xlLmxvZyhcclxuICAgIGDwn5OdIFtnZXRDaGFyYWN0ZXJEZXNjcmlwdGlvbl0gUmVzdWx0OiAke3Jlc3VsdC5zdWJzdHJpbmcoMCwgNTApfS4uLmBcclxuICApO1xyXG4gIGNvbnNvbGUubG9nKFwi8J+UpyBbREVCVUddIEV4aXRpbmcgZ2V0Q2hhcmFjdGVyRGVzY3JpcHRpb24oKVwiKTtcclxuICByZXR1cm4gcmVzdWx0O1xyXG59O1xyXG5cclxuY29uc3QgY3JlYXRlQ29udmVyc2F0aW9uQ2hhaW4gPSAoXHJcbiAgY2hhcmFjdGVyRGVzY3JpcHRpb246IHN0cmluZyxcclxuICBidWZmZXJNZW1vcnk6IGFueVxyXG4pID0+IHtcclxuICBjb25zb2xlLmxvZyhcIvCflKcgW0RFQlVHXSBFbnRlcmVkIGNyZWF0ZUNvbnZlcnNhdGlvbkNoYWluKClcIik7XHJcblxyXG4gIGlmICghcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVkpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCLinYwgW0VSUk9SXSBPUEVOQUlfQVBJX0tFWSBpcyBub3Qgc2V0IGluIGVudmlyb25tZW50IHZhcmlhYmxlc1wiKTtcclxuICAgIHRocm93IG5ldyBFcnJvcihcIk9QRU5BSV9BUElfS0VZIGlzIG5vdCBzZXRcIik7XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnNvbGUubG9nKFwi4pyFIFtJTkZPXSBPUEVOQUlfQVBJX0tFWSBpcyBzZXRcIik7XHJcbiAgfVxyXG5cclxuICBjb25zb2xlLmxvZyhcIvCflJcgW0NSRUFURV9DSEFJTl0gQ3JlYXRpbmcgbmV3IGNvbnZlcnNhdGlvbiBjaGFpblwiKTtcclxuICBjb25zdCBsbG0gPSBuZXcgQ2hhdE9wZW5BSSh7XHJcbiAgICBtb2RlbE5hbWU6IFwiZ3B0LTRcIixcclxuICAgIHRlbXBlcmF0dXJlOiAwLjksXHJcbiAgICBvcGVuQUlBcGlLZXk6IHByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZLFxyXG4gIH0pO1xyXG4gIGNvbnNvbGUubG9nKGDwn6SWIFtDUkVBVEVfQ0hBSU5dIExMTSBjcmVhdGVkIHdpdGggbW9kZWw6ICR7bGxtLm1vZGVsTmFtZX1gKTtcclxuXHJcbiAgY29uc3QgcHJvbXB0ID0gQ2hhdFByb21wdFRlbXBsYXRlLmZyb21NZXNzYWdlcyhbXHJcbiAgICBTeXN0ZW1NZXNzYWdlUHJvbXB0VGVtcGxhdGUuZnJvbVRlbXBsYXRlKGNoYXJhY3RlckRlc2NyaXB0aW9uKSxcclxuICAgIG5ldyBNZXNzYWdlc1BsYWNlaG9sZGVyKFwic2hvcnRUZXJtSGlzdG9yeVwiKSxcclxuICAgIEh1bWFuTWVzc2FnZVByb21wdFRlbXBsYXRlLmZyb21UZW1wbGF0ZShcIntpbnB1dH1cIiksXHJcbiAgXSk7XHJcbiAgY29uc29sZS5sb2coXCLwn5OdIFtDUkVBVEVfQ0hBSU5dIFByb21wdCB0ZW1wbGF0ZSBjcmVhdGVkXCIpO1xyXG5cclxuICBjb25zdCBjaGFpbiA9IG5ldyBDb252ZXJzYXRpb25DaGFpbih7XHJcbiAgICBwcm9tcHQ6IHByb21wdCxcclxuICAgIGxsbTogbGxtLFxyXG4gICAgbWVtb3J5OiBidWZmZXJNZW1vcnksXHJcbiAgICB2ZXJib3NlOiB0cnVlLFxyXG4gIH0pO1xyXG4gIGNvbnNvbGUubG9nKFwi4pyFIFtDUkVBVEVfQ0hBSU5dIENvbnZlcnNhdGlvbiBjaGFpbiBjcmVhdGVkIHN1Y2Nlc3NmdWxseVwiKTtcclxuXHJcbiAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gRXhpdGluZyBjcmVhdGVDb252ZXJzYXRpb25DaGFpbigpXCIpO1xyXG4gIHJldHVybiBjaGFpbjtcclxufTtcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKFxyXG4gIHJlcTogTmV4dFJlcXVlc3QsXHJcbiAgeyBwYXJhbXMgfTogeyBwYXJhbXM6IHsgY2hhdElkOiBzdHJpbmcgfSB9XHJcbikge1xyXG4gIGNvbnNvbGUubG9nKFwi8J+agCBbUE9TVF0gU3RhcnRpbmcgUE9TVCByZXF1ZXN0IGhhbmRsaW5nIGZvciBjaGF0SWQ6XCIsIHBhcmFtcy5jaGF0SWQpO1xyXG4gIHRyeSB7XHJcbiAgICAvLyBQYXJzZSB0aGUgcmVxdWVzdCBib2R5XHJcbiAgICBjb25zdCB7IHByb21wdCB9ID0gYXdhaXQgcmVxLmpzb24oKTtcclxuICAgIGNvbnNvbGUubG9nKGDwn5OlIFtQT1NUXSBSZWNlaXZlZCBwcm9tcHQ6IFwiJHtwcm9tcHR9XCJgKTtcclxuXHJcbiAgICAvLyBHZXQgdXNlciBJRFxyXG4gICAgY29uc3QgeyB1c2VySWQgfSA9IGdldEF1dGgocmVxKTtcclxuICAgIGNvbnNvbGUubG9nKGDwn5GkIFtQT1NUXSBVc2VyIElEOiAke3VzZXJJZH1gKTtcclxuXHJcbiAgICBpZiAoIXVzZXJJZCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhcIvCfmqsgW1BPU1RdIFVuYXV0aG9yaXplZCBhY2Nlc3MgYXR0ZW1wdFwiKTtcclxuICAgICAgcmV0dXJuIG5ldyBOZXh0UmVzcG9uc2UoXCJVbmF1dGhvcml6ZWRcIiwgeyBzdGF0dXM6IDQwMSB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBSYXRlIGxpbWl0aW5nXHJcbiAgICBjb25zdCB7IHN1Y2Nlc3MgfSA9IGF3YWl0IHJhdGVMaW1pdChyZXEpO1xyXG4gICAgY29uc29sZS5sb2coYPCfmqYgW1BPU1RdIFJhdGUgbGltaXQgY2hlY2sgcmVzdWx0OiAke3N1Y2Nlc3N9YCk7XHJcbiAgICBpZiAoIXN1Y2Nlc3MpIHtcclxuICAgICAgY29uc29sZS5sb2coXCLwn5uRIFtQT1NUXSBSYXRlIGxpbWl0IGV4Y2VlZGVkXCIpO1xyXG4gICAgICByZXR1cm4gbmV3IE5leHRSZXNwb25zZShcIlJhdGUgbGltaXQgZXhjZWVkZWRcIiwgeyBzdGF0dXM6IDQyOSB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGZXRjaCBjb21wYW5pb24gZGF0YVxyXG4gICAgY29uc29sZS5sb2coYPCflI0gW1BPU1RdIEZldGNoaW5nIGNvbXBhbmlvbiBkYXRhIGZvciBjaGF0SWQ6ICR7cGFyYW1zLmNoYXRJZH1gKTtcclxuICAgIGNvbnN0IGNvbXBhbmlvbiA9IGF3YWl0IHByaXNtYWRiLmNvbXBhbmlvbi5maW5kVW5pcXVlKHtcclxuICAgICAgd2hlcmU6IHsgaWQ6IHBhcmFtcy5jaGF0SWQgfSxcclxuICAgICAgaW5jbHVkZTogeyBtZXNzYWdlczogdHJ1ZSB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCFjb21wYW5pb24pIHtcclxuICAgICAgY29uc29sZS5sb2coXCLinYwgW1BPU1RdIENvbXBhbmlvbiBub3QgZm91bmRcIik7XHJcbiAgICAgIHJldHVybiBuZXcgTmV4dFJlc3BvbnNlKFwiQ29tcGFuaW9uIG5vdCBmb3VuZFwiLCB7IHN0YXR1czogNDA0IH0pO1xyXG4gICAgfVxyXG4gICAgY29uc29sZS5sb2coYOKchSBbUE9TVF0gQ29tcGFuaW9uIGZvdW5kOiAke2NvbXBhbmlvbi5pZH1gKTtcclxuXHJcbiAgICAvLyBQcm9jZXNzIGNoYXJhY3RlciBkZXNjcmlwdGlvblxyXG4gICAgY29uc3QgY2hhcmFjdGVyRGVzY3JpcHRpb24gPSBnZXRDaGFyYWN0ZXJEZXNjcmlwdGlvbihcclxuICAgICAgY29tcGFuaW9uLmNoYXJhY3RlckRlc2NyaXB0aW9uXHJcbiAgICApO1xyXG4gICAgY29uc29sZS5sb2coYPCfk50gW1BPU1RdIENoYXJhY3RlciBkZXNjcmlwdGlvbiBwcm9jZXNzZWRgKTtcclxuXHJcbiAgICAvLyBJbml0aWFsaXplIE1lbW9yeU1hbmFnZXJcclxuICAgIGNvbnNvbGUubG9nKFwi8J+noCBbUE9TVF0gSW5pdGlhbGl6aW5nIE1lbW9yeU1hbmFnZXJcIik7XHJcbiAgICBjb25zdCBtZW1vcnlNYW5hZ2VyID0gYXdhaXQgTWVtb3J5TWFuYWdlci5nZXRJbnN0YW5jZSgpO1xyXG5cclxuICAgIGNvbnN0IGNvbXBhbmlvbktleTogQ29tcGFuaW9uS2V5ID0ge1xyXG4gICAgICBjb21wYW5pb25JZDogY29tcGFuaW9uLmlkLFxyXG4gICAgICB1c2VySWQ6IHVzZXJJZCxcclxuICAgIH07XHJcbiAgICBjb25zb2xlLmxvZyhg8J+UkSBbUE9TVF0gQ29tcGFuaW9uS2V5IGNyZWF0ZWQ6ICR7SlNPTi5zdHJpbmdpZnkoY29tcGFuaW9uS2V5KX1gKTtcclxuXHJcbiAgICAvLyBDcmVhdGUgb3IgcmV1c2UgY29udmVyc2F0aW9uIGNoYWluXHJcbiAgICBsZXQgY2hhaW4gPSBjb252ZXJzYXRpb25DaGFpbnMuZ2V0KHBhcmFtcy5jaGF0SWQpO1xyXG4gICAgaWYgKCFjaGFpbikge1xyXG4gICAgICBjb25zb2xlLmxvZyhcIvCfhpUgW1BPU1RdIENyZWF0aW5nIG5ldyBjb252ZXJzYXRpb24gY2hhaW5cIik7XHJcbiAgICAgIGNvbnN0IHsgYnVmZmVyTWVtb3J5IH0gPSBhd2FpdCBtZW1vcnlNYW5hZ2VyLmdldE1lbW9yeU1hbmFnZXIoY29tcGFuaW9uS2V5KTtcclxuICAgICAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gT2J0YWluZWQgYnVmZmVyTWVtb3J5IGZyb20gTWVtb3J5TWFuYWdlclwiKTtcclxuICAgICAgY2hhaW4gPSBjcmVhdGVDb252ZXJzYXRpb25DaGFpbihjaGFyYWN0ZXJEZXNjcmlwdGlvbiwgYnVmZmVyTWVtb3J5KTtcclxuICAgICAgY29udmVyc2F0aW9uQ2hhaW5zLnNldChwYXJhbXMuY2hhdElkLCBjaGFpbik7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwi4pyFIFtQT1NUXSBOZXcgY29udmVyc2F0aW9uIGNoYWluIGNyZWF0ZWQgYW5kIHN0b3JlZFwiKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwi4pm777iPIFtQT1NUXSBSZXVzaW5nIGV4aXN0aW5nIGNvbnZlcnNhdGlvbiBjaGFpblwiKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBEZXRlcm1pbmUgaWYgbG9uZy10ZXJtIG1lbW9yeSBzaG91bGQgYmUgdXNlZFxyXG4gICAgY29uc3QgbWVzc2FnZUNvdW50ID0gY29tcGFuaW9uLm1lc3NhZ2VzLmxlbmd0aDtcclxuICAgIGNvbnNvbGUubG9nKGDwn5OKIFtQT1NUXSBUb3RhbCBtZXNzYWdlIGNvdW50OiAke21lc3NhZ2VDb3VudH1gKTtcclxuICAgIGxldCByZWxldmFudE1lbW9yaWVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgaWYgKG1lc3NhZ2VDb3VudCA+PSAxMCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhcIvCflI0gW1BPU1RdIFJldHJpZXZpbmcgcmVsZXZhbnQgbG9uZy10ZXJtIG1lbW9yaWVzXCIpO1xyXG4gICAgICByZWxldmFudE1lbW9yaWVzID0gYXdhaXQgbWVtb3J5TWFuYWdlci5nZXRSZWxldmFudE1lbW9yaWVzKFxyXG4gICAgICAgIGNvbXBhbmlvbktleSxcclxuICAgICAgICBwcm9tcHRcclxuICAgICAgKTtcclxuICAgICAgY29uc29sZS5sb2coYPCfk5ogW1BPU1RdIFJldHJpZXZlZCAke3JlbGV2YW50TWVtb3JpZXMubGVuZ3RofSByZWxldmFudCBtZW1vcmllc2ApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc29sZS5sb2coXHJcbiAgICAgICAgXCLwn5SNIFtQT1NUXSBTa2lwcGluZyBsb25nLXRlcm0gbWVtb3J5IHJldHJpZXZhbCBhcyBtZXNzYWdlIGNvdW50IGlzIGxlc3MgdGhhbiAxMFwiXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gR2VuZXJhdGUgQUkgcmVzcG9uc2VcclxuICAgIGNvbnNvbGUubG9nKFwi8J+SrCBbUE9TVF0gR2VuZXJhdGluZyBBSSByZXNwb25zZSB3aXRoIHByb21wdDpcIiwgcHJvbXB0KTtcclxuICAgIGNvbnNvbGUubG9nKFwi8J+UpyBbREVCVUddIEFib3V0IHRvIGNhbGwgY2hhaW4uY2FsbCgpXCIpO1xyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjaGFpbi5jYWxsKHtcclxuICAgICAgaW5wdXQ6IHByb21wdCxcclxuICAgICAgbG9uZ1Rlcm1IaXN0b3J5OiByZWxldmFudE1lbW9yaWVzLmpvaW4oXCJcXG5cIikgfHwgXCJcIixcclxuICAgIH0pO1xyXG4gICAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gUmVjZWl2ZWQgcmVzcG9uc2UgZnJvbSBjaGFpbi5jYWxsKClcIik7XHJcbiAgICBjb25zdCBhaU1lc3NhZ2UgPSByZXNwb25zZS5yZXNwb25zZS50cmltKCk7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+kliBbUE9TVF0gQUkgcmVzcG9uc2UgZ2VuZXJhdGVkOiBcIiR7YWlNZXNzYWdlfVwiYCk7XHJcblxyXG4gICAgLy8gU3RvcmUgdXNlciBtZXNzYWdlIGluIGRhdGFiYXNlXHJcbiAgICBjb25zb2xlLmxvZyhcIvCfkr4gW1BPU1RdIFN0b3JpbmcgdXNlciBtZXNzYWdlIGluIGRhdGFiYXNlXCIpO1xyXG4gICAgYXdhaXQgcHJpc21hZGIubWVzc2FnZS5jcmVhdGUoe1xyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgY29udGVudDogcHJvbXB0LFxyXG4gICAgICAgIHJvbGU6IFwidXNlclwiLFxyXG4gICAgICAgIHVzZXJJZDogdXNlcklkLFxyXG4gICAgICAgIGNvbXBhbmlvbklkOiBjb21wYW5pb24uaWQsXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBTdG9yZSBBSSByZXNwb25zZSBpbiBkYXRhYmFzZVxyXG4gICAgY29uc29sZS5sb2coXCLwn5K+IFtQT1NUXSBTdG9yaW5nIEFJIHJlc3BvbnNlIGluIGRhdGFiYXNlXCIpO1xyXG4gICAgYXdhaXQgcHJpc21hZGIubWVzc2FnZS5jcmVhdGUoe1xyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgY29udGVudDogYWlNZXNzYWdlLFxyXG4gICAgICAgIHJvbGU6IFwic3lzdGVtXCIsXHJcbiAgICAgICAgdXNlcklkOiB1c2VySWQsXHJcbiAgICAgICAgY29tcGFuaW9uSWQ6IGNvbXBhbmlvbi5pZCxcclxuICAgICAgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgYWdlbnQgbWVtb3J5IHdpdGggdGhlIGxhdGVzdCBjb252ZXJzYXRpb25cclxuICAgIGlmIChtZXNzYWdlQ291bnQgPj0gMTApIHtcclxuICAgICAgY29uc29sZS5sb2coXCLwn6egIFtQT1NUXSBVcGRhdGluZyBhZ2VudCBtZW1vcnkgd2l0aCBsYXRlc3QgY29udmVyc2F0aW9uXCIpO1xyXG4gICAgICBhd2FpdCBtZW1vcnlNYW5hZ2VyLnVwZGF0ZUFnZW50TWVtb3J5KGNvbXBhbmlvbktleSwgcHJvbXB0LCBhaU1lc3NhZ2UpO1xyXG4gICAgICBjb25zb2xlLmxvZyhcIuKchSBbUE9TVF0gQWdlbnQgbWVtb3J5IHVwZGF0ZWRcIik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zb2xlLmxvZyhcclxuICAgICAgICBcIvCfp6AgW1BPU1RdIFNraXBwaW5nIGFnZW50IG1lbW9yeSB1cGRhdGUgYXMgbWVzc2FnZSBjb3VudCBpcyBsZXNzIHRoYW4gMTBcIlxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnNvbGUubG9nKFwi8J+PgSBbUE9TVF0gUmVxdWVzdCBoYW5kbGluZyBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5XCIpO1xyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgc3lzdGVtTWVzc2FnZTogYWlNZXNzYWdlIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKFwi4p2MIFtQT1NUX0VSUk9SXSBBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgcmVxdWVzdCBwcm9jZXNzaW5nOlwiKTtcclxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIG5hbWU6ICR7ZXJyb3IubmFtZX1gKTtcclxuICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgbWVzc2FnZTogJHtlcnJvci5tZXNzYWdlfWApO1xyXG4gICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBzdGFjazogJHtlcnJvci5zdGFja31gKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBkZXRhaWxzOlwiLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgMikpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAge1xyXG4gICAgICAgIGVycm9yOiBcIkFuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWRcIixcclxuICAgICAgICBkZXRhaWxzOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFwiVW5rbm93biBlcnJvclwiLFxyXG4gICAgICB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgc3RhdHVzOiA1MDAsXHJcbiAgICAgIH1cclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdLCJuYW1lcyI6WyJOZXh0UmVzcG9uc2UiLCJnZXRBdXRoIiwiQ2hhdE9wZW5BSSIsIkNvbnZlcnNhdGlvbkNoYWluIiwiQ2hhdFByb21wdFRlbXBsYXRlIiwiSHVtYW5NZXNzYWdlUHJvbXB0VGVtcGxhdGUiLCJTeXN0ZW1NZXNzYWdlUHJvbXB0VGVtcGxhdGUiLCJNZXNzYWdlc1BsYWNlaG9sZGVyIiwiTWVtb3J5TWFuYWdlciIsInByaXNtYWRiIiwicmF0ZUxpbWl0IiwiY29uc29sZSIsImxvZyIsInByb2Nlc3MiLCJlbnYiLCJPUEVOQUlfQVBJX0tFWSIsImNvbnZlcnNhdGlvbkNoYWlucyIsIk1hcCIsImdldENoYXJhY3RlckRlc2NyaXB0aW9uIiwiZGVzY3JpcHRpb24iLCJyZXN1bHQiLCJKU09OIiwic3RyaW5naWZ5Iiwic3Vic3RyaW5nIiwiY3JlYXRlQ29udmVyc2F0aW9uQ2hhaW4iLCJjaGFyYWN0ZXJEZXNjcmlwdGlvbiIsImJ1ZmZlck1lbW9yeSIsImVycm9yIiwiRXJyb3IiLCJsbG0iLCJtb2RlbE5hbWUiLCJ0ZW1wZXJhdHVyZSIsIm9wZW5BSUFwaUtleSIsInByb21wdCIsImZyb21NZXNzYWdlcyIsImZyb21UZW1wbGF0ZSIsImNoYWluIiwibWVtb3J5IiwidmVyYm9zZSIsIlBPU1QiLCJyZXEiLCJwYXJhbXMiLCJjaGF0SWQiLCJqc29uIiwidXNlcklkIiwic3RhdHVzIiwic3VjY2VzcyIsImNvbXBhbmlvbiIsImZpbmRVbmlxdWUiLCJ3aGVyZSIsImlkIiwiaW5jbHVkZSIsIm1lc3NhZ2VzIiwibWVtb3J5TWFuYWdlciIsImdldEluc3RhbmNlIiwiY29tcGFuaW9uS2V5IiwiY29tcGFuaW9uSWQiLCJnZXQiLCJnZXRNZW1vcnlNYW5hZ2VyIiwic2V0IiwibWVzc2FnZUNvdW50IiwibGVuZ3RoIiwicmVsZXZhbnRNZW1vcmllcyIsImdldFJlbGV2YW50TWVtb3JpZXMiLCJyZXNwb25zZSIsImNhbGwiLCJpbnB1dCIsImxvbmdUZXJtSGlzdG9yeSIsImpvaW4iLCJhaU1lc3NhZ2UiLCJ0cmltIiwibWVzc2FnZSIsImNyZWF0ZSIsImRhdGEiLCJjb250ZW50Iiwicm9sZSIsInVwZGF0ZUFnZW50TWVtb3J5Iiwic3lzdGVtTWVzc2FnZSIsIm5hbWUiLCJzdGFjayIsImRldGFpbHMiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./src/app/api/chat/[chatId]/route.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/memory.ts":
/*!***************************!*\
  !*** ./src/lib/memory.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   MemoryManager: () => (/* binding */ MemoryManager)\n/* harmony export */ });\n/* harmony import */ var _prisma_client__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @prisma/client */ \"@prisma/client\");\n/* harmony import */ var _prisma_client__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_prisma_client__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _langchain_community_vectorstores_faiss__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @langchain/community/vectorstores/faiss */ \"(rsc)/./node_modules/@langchain/community/vectorstores/faiss.js\");\n/* harmony import */ var _langchain_openai__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @langchain/openai */ \"(rsc)/./node_modules/@langchain/openai/index.js\");\n/* harmony import */ var langchain_experimental_generative_agents__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! langchain/experimental/generative_agents */ \"(rsc)/./node_modules/langchain/experimental/generative_agents.js\");\n/* harmony import */ var langchain_retrievers_time_weighted__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! langchain/retrievers/time_weighted */ \"(rsc)/./node_modules/langchain/retrievers/time_weighted.js\");\n/* harmony import */ var langchain_memory__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! langchain/memory */ \"(rsc)/./node_modules/langchain/memory.js\");\n// src/lib/memory.ts\n\n\n\n\n\n\n\nclass MemoryManager {\n    constructor(){\n        this.agentMemories = new Map();\n        this.bufferMemories = new Map();\n        console.log(\"\\uD83C\\uDFD7️ [MemoryManager] Constructor called\");\n        this.prisma = new _prisma_client__WEBPACK_IMPORTED_MODULE_0__.PrismaClient();\n        console.log(\"\\uD83D\\uDD0C [MemoryManager] PrismaClient initialized\");\n    }\n    static async getInstance() {\n        console.log(\"\\uD83D\\uDD0D [MemoryManager] getInstance called\");\n        if (!MemoryManager.instance) {\n            console.log(\"\\uD83C\\uDD95 [MemoryManager] Creating new MemoryManager instance\");\n            MemoryManager.instance = new MemoryManager();\n        } else {\n            console.log(\"♻️ [MemoryManager] Reusing existing MemoryManager instance\");\n        }\n        return MemoryManager.instance;\n    }\n    async getOrCreateAgentMemory(companionKey) {\n        const key = `${companionKey.userId}:${companionKey.companionId}`;\n        console.log(`🔧 [DEBUG] Entered getOrCreateAgentMemory() with key: ${key}`);\n        if (!this.agentMemories.has(key)) {\n            console.log(`🆕 [MemoryManager] Creating new GenerativeAgentMemory for ${key}`);\n            if (!process.env.OPENAI_API_KEY) {\n                console.error(\"❌ [ERROR] OPENAI_API_KEY is not set in environment variables\");\n                throw new Error(\"OPENAI_API_KEY is not set\");\n            } else {\n                console.log(\"✅ [INFO] OPENAI_API_KEY is set\");\n            }\n            console.log(\"\\uD83E\\uDD16 [MemoryManager] Creating ChatOpenAI instance\");\n            const llm = new _langchain_openai__WEBPACK_IMPORTED_MODULE_2__.ChatOpenAI({\n                modelName: \"gpt-4\",\n                temperature: 0.9,\n                openAIApiKey: process.env.OPENAI_API_KEY\n            });\n            console.log(\"\\uD83E\\uDD16 [MemoryManager] ChatOpenAI instance created\");\n            console.log(\"\\uD83E\\uDDE0 [MemoryManager] Creating OpenAIEmbeddings instance\");\n            const embeddings = new _langchain_openai__WEBPACK_IMPORTED_MODULE_2__.OpenAIEmbeddings({\n                apiKey: process.env.OPENAI_API_KEY\n            });\n            console.log(\"\\uD83E\\uDDE0 [MemoryManager] OpenAIEmbeddings instance created\");\n            // Retrieve previous messages to initialize the vector store\n            console.log(\"\\uD83D\\uDCD6 [MemoryManager] Retrieving latest history for vector store initialization\");\n            const previousMessages = await this.readLatestHistory(companionKey);\n            console.log(`📚 [MemoryManager] Retrieved ${previousMessages.length} previous messages`);\n            const initialTexts = previousMessages.length > 0 ? previousMessages : [\n                \"Initialize memory\"\n            ];\n            console.log(`📄 [MemoryManager] Initial texts for vector store: ${initialTexts.length} texts`);\n            console.log(\"\\uD83D\\uDCCA [MemoryManager] Creating FaissStore vector store\");\n            const vectorStore = await _langchain_community_vectorstores_faiss__WEBPACK_IMPORTED_MODULE_1__.FaissStore.fromTexts(initialTexts, initialTexts.map((_, idx)=>({\n                    id: idx + 1\n                })), embeddings);\n            console.log(\"\\uD83D\\uDCCA [MemoryManager] FaissStore vector store created\");\n            console.log(\"⏲️ [MemoryManager] Creating TimeWeightedVectorStoreRetriever\");\n            const memoryRetriever = new langchain_retrievers_time_weighted__WEBPACK_IMPORTED_MODULE_4__.TimeWeightedVectorStoreRetriever({\n                vectorStore,\n                otherScoreKeys: [\n                    \"importance\"\n                ],\n                k: 15\n            });\n            console.log(\"⏲️ [MemoryManager] TimeWeightedVectorStoreRetriever created\");\n            console.log(\"\\uD83E\\uDDE0 [MemoryManager] Creating GenerativeAgentMemory instance\");\n            const agentMemory = new langchain_experimental_generative_agents__WEBPACK_IMPORTED_MODULE_3__.GenerativeAgentMemory(llm, memoryRetriever, {\n                reflectionThreshold: 8,\n                importanceWeight: 0.15,\n                verbose: true,\n                maxTokensLimit: 1200\n            });\n            console.log(\"\\uD83E\\uDDE0 [MemoryManager] GenerativeAgentMemory instance created\");\n            this.agentMemories.set(key, agentMemory);\n            console.log(`✅ [MemoryManager] New GenerativeAgentMemory stored for key: ${key}`);\n        } else {\n            console.log(`♻️ [MemoryManager] Reusing existing GenerativeAgentMemory for key: ${key}`);\n        }\n        console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting getOrCreateAgentMemory()\");\n        return this.agentMemories.get(key);\n    }\n    getOrCreateBufferMemory(companionKey) {\n        const key = `${companionKey.userId}:${companionKey.companionId}`;\n        console.log(`🔧 [DEBUG] Entered getOrCreateBufferMemory() with key: ${key}`);\n        if (!this.bufferMemories.has(key)) {\n            console.log(`🆕 [MemoryManager] Creating new BufferMemory for ${key}`);\n            const bufferMemory = new langchain_memory__WEBPACK_IMPORTED_MODULE_5__.BufferMemory({\n                returnMessages: true,\n                memoryKey: \"shortTermHistory\"\n            });\n            this.bufferMemories.set(key, bufferMemory);\n            console.log(`✅ [MemoryManager] New BufferMemory stored for key: ${key}`);\n        } else {\n            console.log(`♻️ [MemoryManager] Reusing existing BufferMemory for key: ${key}`);\n        }\n        console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting getOrCreateBufferMemory()\");\n        return this.bufferMemories.get(key);\n    }\n    async addMemory(companionKey, text) {\n        console.log(`🔧 [DEBUG] Entered addMemory() for key: ${companionKey.companionId}`);\n        console.log(`📝 [MemoryManager] Memory content: \"${text.substring(0, 50)}...\"`);\n        try {\n            const agentMemory = await this.getOrCreateAgentMemory(companionKey);\n            await agentMemory.addMemory(text, new Date());\n            console.log(`✅ [MemoryManager] Memory added to GenerativeAgentMemory`);\n        } catch (error) {\n            console.error(`❌ [MemoryManager] Error adding memory to agentMemory:`, error);\n        }\n        try {\n            await this.prisma.message.create({\n                data: {\n                    content: text,\n                    userId: companionKey.userId,\n                    companionId: companionKey.companionId,\n                    role: \"user\"\n                }\n            });\n            console.log(`💾 [MemoryManager] Memory stored in Prisma database`);\n        } catch (error) {\n            console.error(`❌ [MemoryManager] Error storing memory in Prisma:`, error);\n        }\n        console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting addMemory()\");\n    }\n    async updateAgentMemory(companionKey, userInput, aiResponse) {\n        console.log(`🔧 [DEBUG] Entered updateAgentMemory() for key: ${companionKey.companionId}`);\n        console.log(`👤 [MemoryManager] User input: \"${userInput}\"`);\n        console.log(`🤖 [MemoryManager] AI response: \"${aiResponse}\"`);\n        try {\n            const agentMemory = await this.getOrCreateAgentMemory(companionKey);\n            await agentMemory.addMemory(`User: ${userInput}`, new Date());\n            await agentMemory.addMemory(`Assistant: ${aiResponse}`, new Date());\n            console.log(`✅ [MemoryManager] Agent memory updated with latest conversation`);\n        } catch (error) {\n            console.error(`❌ [MemoryManager] Error updating agent memory:`, error);\n        }\n        console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting updateAgentMemory()\");\n    }\n    async getRelevantMemories(companionKey, query) {\n        console.log(`🔧 [DEBUG] Entered getRelevantMemories() for key: ${companionKey.companionId}`);\n        console.log(`📝 [MemoryManager] Query: \"${query}\"`);\n        try {\n            const agentMemory = await this.getOrCreateAgentMemory(companionKey);\n            console.log(`🧠 [MemoryManager] Retrieved agent memory for companion`);\n            const relevantMemories = await agentMemory.memoryRetriever.getRelevantDocuments(query);\n            console.log(`✅ [MemoryManager] Retrieved ${relevantMemories.length} relevant memories`);\n            relevantMemories.forEach((mem, index)=>{\n                console.log(`📎 [MemoryManager] Memory ${index + 1}: \"${mem.pageContent.substring(0, 50)}...\"`);\n            });\n            console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting getRelevantMemories()\");\n            return relevantMemories.map((mem)=>mem.pageContent);\n        } catch (error) {\n            console.error(`❌ [MemoryManager] Error retrieving relevant memories:`, error);\n            console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting getRelevantMemories() with error\");\n            return [];\n        }\n    }\n    async readLatestHistory(companionKey) {\n        console.log(`🔧 [DEBUG] Entered readLatestHistory() for key: ${companionKey.companionId}`);\n        try {\n            const messages = await this.prisma.message.findMany({\n                where: {\n                    userId: companionKey.userId,\n                    companionId: companionKey.companionId\n                },\n                orderBy: {\n                    createdAt: \"desc\"\n                },\n                take: 30\n            });\n            console.log(`✅ [MemoryManager] Retrieved ${messages.length} messages from database`);\n            messages.forEach((msg, index)=>{\n                console.log(`📄 [MemoryManager] Message ${index + 1}: \"${msg.content.substring(0, 50)}...\"`);\n            });\n            console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting readLatestHistory()\");\n            return messages.map((msg)=>msg.content);\n        } catch (error) {\n            console.error(`❌ [MemoryManager] Error retrieving latest history:`, error);\n            console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting readLatestHistory() with error\");\n            return [];\n        }\n    }\n    async seedChatHistory(seed, delimiter, companionKey) {\n        console.log(`🔧 [DEBUG] Entered seedChatHistory() for key: ${companionKey.companionId}`);\n        console.log(`🌱 [MemoryManager] Seed text length: ${seed.length}`);\n        const messages = seed.split(delimiter);\n        console.log(`📊 [MemoryManager] Seeding ${messages.length} messages`);\n        for (const message of messages){\n            await this.addMemory(companionKey, message);\n            console.log(`➕ [MemoryManager] Seeded message: \"${message.substring(0, 50)}...\"`);\n        }\n        console.log(`✅ [MemoryManager] Chat history seeding completed`);\n        console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting seedChatHistory()\");\n    }\n    async clearHistory(companionKey) {\n        console.log(`🔧 [DEBUG] Entered clearHistory() for key: ${companionKey.companionId}`);\n        if (!companionKey.userId) {\n            console.error(`❌ [MemoryManager] Companion key set incorrectly`);\n            console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting clearHistory() due to invalid companionKey\");\n            return;\n        }\n        try {\n            const deleteResult = await this.prisma.message.deleteMany({\n                where: {\n                    userId: companionKey.userId,\n                    companionId: companionKey.companionId\n                }\n            });\n            console.log(`🗑️ [MemoryManager] Deleted ${deleteResult.count} messages from database`);\n            const key = `${companionKey.userId}:${companionKey.companionId}`;\n            this.agentMemories.delete(key);\n            this.bufferMemories.delete(key);\n            console.log(`🧹 [MemoryManager] Cleared vector store and buffer memory for key: ${key}`);\n            console.log(`✅ [MemoryManager] Chat history cleared successfully`);\n        } catch (error) {\n            console.error(`❌ [MemoryManager] Error clearing chat history:`, error);\n        }\n        console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting clearHistory()\");\n    }\n    async getMemoryManager(companionKey) {\n        console.log(`🔧 [DEBUG] Entered getMemoryManager() for key: ${companionKey.companionId}`);\n        const bufferMemory = this.getOrCreateBufferMemory(companionKey);\n        console.log(`✅ [MemoryManager] BufferMemory retrieved for key: ${companionKey.companionId}`);\n        console.log(\"\\uD83D\\uDD27 [DEBUG] Exiting getMemoryManager()\");\n        return {\n            bufferMemory\n        };\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QTRCLEVBQUU2RSxhQUFhRSxLQUFLLENBQUMsdUJBQXVCLENBQUM7WUFFdEYsTUFBTXpFLE1BQU0sQ0FBQyxFQUFFRCxhQUFhRSxNQUFNLENBQUMsQ0FBQyxFQUFFRixhQUFhRyxXQUFXLENBQUMsQ0FBQztZQUNoRSxJQUFJLENBQUNaLGFBQWEsQ0FBQ29GLE1BQU0sQ0FBQzFFO1lBQzFCLElBQUksQ0FBQ1IsY0FBYyxDQUFDa0YsTUFBTSxDQUFDMUU7WUFDM0JQLFFBQVFDLEdBQUcsQ0FBQyxDQUFDLG1FQUFtRSxFQUFFTSxJQUFJLENBQUM7WUFFdkZQLFFBQVFDLEdBQUcsQ0FBQyxDQUFDLG1EQUFtRCxDQUFDO1FBQ25FLEVBQUUsT0FBT2EsT0FBTztZQUNkZCxRQUFRYyxLQUFLLENBQUMsQ0FBQyw4Q0FBOEMsQ0FBQyxFQUFFQTtRQUNsRTtRQUVBZCxRQUFRQyxHQUFHLENBQUM7SUFDZDtJQUVBLE1BQWFpRixpQkFDWDVFLFlBQTBCLEVBQ2U7UUFDekNOLFFBQVFDLEdBQUcsQ0FBQyxDQUFDLCtDQUErQyxFQUFFSyxhQUFhRyxXQUFXLENBQUMsQ0FBQztRQUN4RixNQUFNa0MsZUFBZSxJQUFJLENBQUNELHVCQUF1QixDQUFDcEM7UUFDbEROLFFBQVFDLEdBQUcsQ0FBQyxDQUFDLGtEQUFrRCxFQUFFSyxhQUFhRyxXQUFXLENBQUMsQ0FBQztRQUMzRlQsUUFBUUMsR0FBRyxDQUFDO1FBQ1osT0FBTztZQUFFMEM7UUFBYTtJQUN4QjtBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vYWktY29tcGFuaW9uLy4vc3JjL2xpYi9tZW1vcnkudHM/OTNlZSJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvbGliL21lbW9yeS50c1xyXG5cclxuaW1wb3J0IHsgUHJpc21hQ2xpZW50IH0gZnJvbSBcIkBwcmlzbWEvY2xpZW50XCI7XHJcbmltcG9ydCB7IEZhaXNzU3RvcmUgfSBmcm9tIFwiQGxhbmdjaGFpbi9jb21tdW5pdHkvdmVjdG9yc3RvcmVzL2ZhaXNzXCI7XHJcbmltcG9ydCB7IE9wZW5BSUVtYmVkZGluZ3MgfSBmcm9tIFwiQGxhbmdjaGFpbi9vcGVuYWlcIjtcclxuaW1wb3J0IHsgR2VuZXJhdGl2ZUFnZW50TWVtb3J5IH0gZnJvbSBcImxhbmdjaGFpbi9leHBlcmltZW50YWwvZ2VuZXJhdGl2ZV9hZ2VudHNcIjtcclxuaW1wb3J0IHsgVGltZVdlaWdodGVkVmVjdG9yU3RvcmVSZXRyaWV2ZXIgfSBmcm9tIFwibGFuZ2NoYWluL3JldHJpZXZlcnMvdGltZV93ZWlnaHRlZFwiO1xyXG5pbXBvcnQgeyBDaGF0T3BlbkFJIH0gZnJvbSBcIkBsYW5nY2hhaW4vb3BlbmFpXCI7XHJcbmltcG9ydCB7IEJ1ZmZlck1lbW9yeSB9IGZyb20gXCJsYW5nY2hhaW4vbWVtb3J5XCI7XHJcblxyXG5leHBvcnQgdHlwZSBDb21wYW5pb25LZXkgPSB7XHJcbiAgY29tcGFuaW9uSWQ6IHN0cmluZztcclxuICB1c2VySWQ6IHN0cmluZztcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBNZW1vcnlNYW5hZ2VyIHtcclxuICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogTWVtb3J5TWFuYWdlcjtcclxuICBwcml2YXRlIHByaXNtYTogUHJpc21hQ2xpZW50O1xyXG4gIHByaXZhdGUgYWdlbnRNZW1vcmllczogTWFwPHN0cmluZywgR2VuZXJhdGl2ZUFnZW50TWVtb3J5PiA9IG5ldyBNYXAoKTtcclxuICBwcml2YXRlIGJ1ZmZlck1lbW9yaWVzOiBNYXA8c3RyaW5nLCBCdWZmZXJNZW1vcnk+ID0gbmV3IE1hcCgpO1xyXG5cclxuICBwcml2YXRlIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgY29uc29sZS5sb2coXCLwn4+X77iPIFtNZW1vcnlNYW5hZ2VyXSBDb25zdHJ1Y3RvciBjYWxsZWRcIik7XHJcbiAgICB0aGlzLnByaXNtYSA9IG5ldyBQcmlzbWFDbGllbnQoKTtcclxuICAgIGNvbnNvbGUubG9nKFwi8J+UjCBbTWVtb3J5TWFuYWdlcl0gUHJpc21hQ2xpZW50IGluaXRpYWxpemVkXCIpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0YXRpYyBhc3luYyBnZXRJbnN0YW5jZSgpOiBQcm9taXNlPE1lbW9yeU1hbmFnZXI+IHtcclxuICAgIGNvbnNvbGUubG9nKFwi8J+UjSBbTWVtb3J5TWFuYWdlcl0gZ2V0SW5zdGFuY2UgY2FsbGVkXCIpO1xyXG4gICAgaWYgKCFNZW1vcnlNYW5hZ2VyLmluc3RhbmNlKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+GlSBbTWVtb3J5TWFuYWdlcl0gQ3JlYXRpbmcgbmV3IE1lbW9yeU1hbmFnZXIgaW5zdGFuY2VcIik7XHJcbiAgICAgIE1lbW9yeU1hbmFnZXIuaW5zdGFuY2UgPSBuZXcgTWVtb3J5TWFuYWdlcigpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc29sZS5sb2coXCLimbvvuI8gW01lbW9yeU1hbmFnZXJdIFJldXNpbmcgZXhpc3RpbmcgTWVtb3J5TWFuYWdlciBpbnN0YW5jZVwiKTtcclxuICAgIH1cclxuICAgIHJldHVybiBNZW1vcnlNYW5hZ2VyLmluc3RhbmNlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRPckNyZWF0ZUFnZW50TWVtb3J5KFxyXG4gICAgY29tcGFuaW9uS2V5OiBDb21wYW5pb25LZXlcclxuICApOiBQcm9taXNlPEdlbmVyYXRpdmVBZ2VudE1lbW9yeT4ge1xyXG4gICAgY29uc3Qga2V5ID0gYCR7Y29tcGFuaW9uS2V5LnVzZXJJZH06JHtjb21wYW5pb25LZXkuY29tcGFuaW9uSWR9YDtcclxuICAgIGNvbnNvbGUubG9nKGDwn5SnIFtERUJVR10gRW50ZXJlZCBnZXRPckNyZWF0ZUFnZW50TWVtb3J5KCkgd2l0aCBrZXk6ICR7a2V5fWApO1xyXG5cclxuICAgIGlmICghdGhpcy5hZ2VudE1lbW9yaWVzLmhhcyhrZXkpKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDwn4aVIFtNZW1vcnlNYW5hZ2VyXSBDcmVhdGluZyBuZXcgR2VuZXJhdGl2ZUFnZW50TWVtb3J5IGZvciAke2tleX1gKTtcclxuXHJcbiAgICAgIGlmICghcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVkpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKFwi4p2MIFtFUlJPUl0gT1BFTkFJX0FQSV9LRVkgaXMgbm90IHNldCBpbiBlbnZpcm9ubWVudCB2YXJpYWJsZXNcIik7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT1BFTkFJX0FQSV9LRVkgaXMgbm90IHNldFwiKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIuKchSBbSU5GT10gT1BFTkFJX0FQSV9LRVkgaXMgc2V0XCIpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhcIvCfpJYgW01lbW9yeU1hbmFnZXJdIENyZWF0aW5nIENoYXRPcGVuQUkgaW5zdGFuY2VcIik7XHJcbiAgICAgIGNvbnN0IGxsbSA9IG5ldyBDaGF0T3BlbkFJKHtcclxuICAgICAgICBtb2RlbE5hbWU6IFwiZ3B0LTRcIixcclxuICAgICAgICB0ZW1wZXJhdHVyZTogMC45LFxyXG4gICAgICAgIG9wZW5BSUFwaUtleTogcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVksXHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zb2xlLmxvZyhcIvCfpJYgW01lbW9yeU1hbmFnZXJdIENoYXRPcGVuQUkgaW5zdGFuY2UgY3JlYXRlZFwiKTtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+noCBbTWVtb3J5TWFuYWdlcl0gQ3JlYXRpbmcgT3BlbkFJRW1iZWRkaW5ncyBpbnN0YW5jZVwiKTtcclxuICAgICAgY29uc3QgZW1iZWRkaW5ncyA9IG5ldyBPcGVuQUlFbWJlZGRpbmdzKHtcclxuICAgICAgICBhcGlLZXk6IHByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZLFxyXG4gICAgICB9KTtcclxuICAgICAgY29uc29sZS5sb2coXCLwn6egIFtNZW1vcnlNYW5hZ2VyXSBPcGVuQUlFbWJlZGRpbmdzIGluc3RhbmNlIGNyZWF0ZWRcIik7XHJcblxyXG4gICAgICAvLyBSZXRyaWV2ZSBwcmV2aW91cyBtZXNzYWdlcyB0byBpbml0aWFsaXplIHRoZSB2ZWN0b3Igc3RvcmVcclxuICAgICAgY29uc29sZS5sb2coXCLwn5OWIFtNZW1vcnlNYW5hZ2VyXSBSZXRyaWV2aW5nIGxhdGVzdCBoaXN0b3J5IGZvciB2ZWN0b3Igc3RvcmUgaW5pdGlhbGl6YXRpb25cIik7XHJcbiAgICAgIGNvbnN0IHByZXZpb3VzTWVzc2FnZXMgPSBhd2FpdCB0aGlzLnJlYWRMYXRlc3RIaXN0b3J5KGNvbXBhbmlvbktleSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKFxyXG4gICAgICAgIGDwn5OaIFtNZW1vcnlNYW5hZ2VyXSBSZXRyaWV2ZWQgJHtwcmV2aW91c01lc3NhZ2VzLmxlbmd0aH0gcHJldmlvdXMgbWVzc2FnZXNgXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBjb25zdCBpbml0aWFsVGV4dHMgPVxyXG4gICAgICAgIHByZXZpb3VzTWVzc2FnZXMubGVuZ3RoID4gMCA/IHByZXZpb3VzTWVzc2FnZXMgOiBbXCJJbml0aWFsaXplIG1lbW9yeVwiXTtcclxuICAgICAgY29uc29sZS5sb2coXHJcbiAgICAgICAgYPCfk4QgW01lbW9yeU1hbmFnZXJdIEluaXRpYWwgdGV4dHMgZm9yIHZlY3RvciBzdG9yZTogJHtpbml0aWFsVGV4dHMubGVuZ3RofSB0ZXh0c2BcclxuICAgICAgKTtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+TiiBbTWVtb3J5TWFuYWdlcl0gQ3JlYXRpbmcgRmFpc3NTdG9yZSB2ZWN0b3Igc3RvcmVcIik7XHJcbiAgICAgIGNvbnN0IHZlY3RvclN0b3JlID0gYXdhaXQgRmFpc3NTdG9yZS5mcm9tVGV4dHMoXHJcbiAgICAgICAgaW5pdGlhbFRleHRzLFxyXG4gICAgICAgIGluaXRpYWxUZXh0cy5tYXAoKF8sIGlkeCkgPT4gKHsgaWQ6IGlkeCArIDEgfSkpLFxyXG4gICAgICAgIGVtYmVkZGluZ3NcclxuICAgICAgKTtcclxuICAgICAgY29uc29sZS5sb2coXCLwn5OKIFtNZW1vcnlNYW5hZ2VyXSBGYWlzc1N0b3JlIHZlY3RvciBzdG9yZSBjcmVhdGVkXCIpO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coXCLij7LvuI8gW01lbW9yeU1hbmFnZXJdIENyZWF0aW5nIFRpbWVXZWlnaHRlZFZlY3RvclN0b3JlUmV0cmlldmVyXCIpO1xyXG4gICAgICBjb25zdCBtZW1vcnlSZXRyaWV2ZXIgPSBuZXcgVGltZVdlaWdodGVkVmVjdG9yU3RvcmVSZXRyaWV2ZXIoe1xyXG4gICAgICAgIHZlY3RvclN0b3JlLFxyXG4gICAgICAgIG90aGVyU2NvcmVLZXlzOiBbXCJpbXBvcnRhbmNlXCJdLFxyXG4gICAgICAgIGs6IDE1LFxyXG4gICAgICB9KTtcclxuICAgICAgY29uc29sZS5sb2coXCLij7LvuI8gW01lbW9yeU1hbmFnZXJdIFRpbWVXZWlnaHRlZFZlY3RvclN0b3JlUmV0cmlldmVyIGNyZWF0ZWRcIik7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhcIvCfp6AgW01lbW9yeU1hbmFnZXJdIENyZWF0aW5nIEdlbmVyYXRpdmVBZ2VudE1lbW9yeSBpbnN0YW5jZVwiKTtcclxuICAgICAgY29uc3QgYWdlbnRNZW1vcnkgPSBuZXcgR2VuZXJhdGl2ZUFnZW50TWVtb3J5KGxsbSwgbWVtb3J5UmV0cmlldmVyLCB7XHJcbiAgICAgICAgcmVmbGVjdGlvblRocmVzaG9sZDogOCxcclxuICAgICAgICBpbXBvcnRhbmNlV2VpZ2h0OiAwLjE1LFxyXG4gICAgICAgIHZlcmJvc2U6IHRydWUsXHJcbiAgICAgICAgbWF4VG9rZW5zTGltaXQ6IDEyMDAsXHJcbiAgICAgIH0pO1xyXG4gICAgICBjb25zb2xlLmxvZyhcIvCfp6AgW01lbW9yeU1hbmFnZXJdIEdlbmVyYXRpdmVBZ2VudE1lbW9yeSBpbnN0YW5jZSBjcmVhdGVkXCIpO1xyXG5cclxuICAgICAgdGhpcy5hZ2VudE1lbW9yaWVzLnNldChrZXksIGFnZW50TWVtb3J5KTtcclxuICAgICAgY29uc29sZS5sb2coYOKchSBbTWVtb3J5TWFuYWdlcl0gTmV3IEdlbmVyYXRpdmVBZ2VudE1lbW9yeSBzdG9yZWQgZm9yIGtleTogJHtrZXl9YCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zb2xlLmxvZyhg4pm777iPIFtNZW1vcnlNYW5hZ2VyXSBSZXVzaW5nIGV4aXN0aW5nIEdlbmVyYXRpdmVBZ2VudE1lbW9yeSBmb3Iga2V5OiAke2tleX1gKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zb2xlLmxvZyhcIvCflKcgW0RFQlVHXSBFeGl0aW5nIGdldE9yQ3JlYXRlQWdlbnRNZW1vcnkoKVwiKTtcclxuICAgIHJldHVybiB0aGlzLmFnZW50TWVtb3JpZXMuZ2V0KGtleSkhO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRPckNyZWF0ZUJ1ZmZlck1lbW9yeShjb21wYW5pb25LZXk6IENvbXBhbmlvbktleSk6IEJ1ZmZlck1lbW9yeSB7XHJcbiAgICBjb25zdCBrZXkgPSBgJHtjb21wYW5pb25LZXkudXNlcklkfToke2NvbXBhbmlvbktleS5jb21wYW5pb25JZH1gO1xyXG4gICAgY29uc29sZS5sb2coYPCflKcgW0RFQlVHXSBFbnRlcmVkIGdldE9yQ3JlYXRlQnVmZmVyTWVtb3J5KCkgd2l0aCBrZXk6ICR7a2V5fWApO1xyXG5cclxuICAgIGlmICghdGhpcy5idWZmZXJNZW1vcmllcy5oYXMoa2V5KSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhg8J+GlSBbTWVtb3J5TWFuYWdlcl0gQ3JlYXRpbmcgbmV3IEJ1ZmZlck1lbW9yeSBmb3IgJHtrZXl9YCk7XHJcbiAgICAgIGNvbnN0IGJ1ZmZlck1lbW9yeSA9IG5ldyBCdWZmZXJNZW1vcnkoe1xyXG4gICAgICAgIHJldHVybk1lc3NhZ2VzOiB0cnVlLFxyXG4gICAgICAgIG1lbW9yeUtleTogXCJzaG9ydFRlcm1IaXN0b3J5XCIsXHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLmJ1ZmZlck1lbW9yaWVzLnNldChrZXksIGJ1ZmZlck1lbW9yeSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDinIUgW01lbW9yeU1hbmFnZXJdIE5ldyBCdWZmZXJNZW1vcnkgc3RvcmVkIGZvciBrZXk6ICR7a2V5fWApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc29sZS5sb2coYOKZu++4jyBbTWVtb3J5TWFuYWdlcl0gUmV1c2luZyBleGlzdGluZyBCdWZmZXJNZW1vcnkgZm9yIGtleTogJHtrZXl9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gRXhpdGluZyBnZXRPckNyZWF0ZUJ1ZmZlck1lbW9yeSgpXCIpO1xyXG4gICAgcmV0dXJuIHRoaXMuYnVmZmVyTWVtb3JpZXMuZ2V0KGtleSkhO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGFkZE1lbW9yeShcclxuICAgIGNvbXBhbmlvbktleTogQ29tcGFuaW9uS2V5LFxyXG4gICAgdGV4dDogc3RyaW5nXHJcbiAgKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+UpyBbREVCVUddIEVudGVyZWQgYWRkTWVtb3J5KCkgZm9yIGtleTogJHtjb21wYW5pb25LZXkuY29tcGFuaW9uSWR9YCk7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+TnSBbTWVtb3J5TWFuYWdlcl0gTWVtb3J5IGNvbnRlbnQ6IFwiJHt0ZXh0LnN1YnN0cmluZygwLCA1MCl9Li4uXCJgKTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBhZ2VudE1lbW9yeSA9IGF3YWl0IHRoaXMuZ2V0T3JDcmVhdGVBZ2VudE1lbW9yeShjb21wYW5pb25LZXkpO1xyXG4gICAgICBhd2FpdCBhZ2VudE1lbW9yeS5hZGRNZW1vcnkodGV4dCwgbmV3IERhdGUoKSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDinIUgW01lbW9yeU1hbmFnZXJdIE1lbW9yeSBhZGRlZCB0byBHZW5lcmF0aXZlQWdlbnRNZW1vcnlgKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBbTWVtb3J5TWFuYWdlcl0gRXJyb3IgYWRkaW5nIG1lbW9yeSB0byBhZ2VudE1lbW9yeTpgLCBlcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS5jcmVhdGUoe1xyXG4gICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgIGNvbnRlbnQ6IHRleHQsXHJcbiAgICAgICAgICB1c2VySWQ6IGNvbXBhbmlvbktleS51c2VySWQsXHJcbiAgICAgICAgICBjb21wYW5pb25JZDogY29tcGFuaW9uS2V5LmNvbXBhbmlvbklkLFxyXG4gICAgICAgICAgcm9sZTogXCJ1c2VyXCIsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDwn5K+IFtNZW1vcnlNYW5hZ2VyXSBNZW1vcnkgc3RvcmVkIGluIFByaXNtYSBkYXRhYmFzZWApO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihg4p2MIFtNZW1vcnlNYW5hZ2VyXSBFcnJvciBzdG9yaW5nIG1lbW9yeSBpbiBQcmlzbWE6YCwgZXJyb3IpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnNvbGUubG9nKFwi8J+UpyBbREVCVUddIEV4aXRpbmcgYWRkTWVtb3J5KClcIik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgdXBkYXRlQWdlbnRNZW1vcnkoXHJcbiAgICBjb21wYW5pb25LZXk6IENvbXBhbmlvbktleSxcclxuICAgIHVzZXJJbnB1dDogc3RyaW5nLFxyXG4gICAgYWlSZXNwb25zZTogc3RyaW5nXHJcbiAgKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+UpyBbREVCVUddIEVudGVyZWQgdXBkYXRlQWdlbnRNZW1vcnkoKSBmb3Iga2V5OiAke2NvbXBhbmlvbktleS5jb21wYW5pb25JZH1gKTtcclxuICAgIGNvbnNvbGUubG9nKGDwn5GkIFtNZW1vcnlNYW5hZ2VyXSBVc2VyIGlucHV0OiBcIiR7dXNlcklucHV0fVwiYCk7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+kliBbTWVtb3J5TWFuYWdlcl0gQUkgcmVzcG9uc2U6IFwiJHthaVJlc3BvbnNlfVwiYCk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgYWdlbnRNZW1vcnkgPSBhd2FpdCB0aGlzLmdldE9yQ3JlYXRlQWdlbnRNZW1vcnkoY29tcGFuaW9uS2V5KTtcclxuICAgICAgYXdhaXQgYWdlbnRNZW1vcnkuYWRkTWVtb3J5KGBVc2VyOiAke3VzZXJJbnB1dH1gLCBuZXcgRGF0ZSgpKTtcclxuICAgICAgYXdhaXQgYWdlbnRNZW1vcnkuYWRkTWVtb3J5KGBBc3Npc3RhbnQ6ICR7YWlSZXNwb25zZX1gLCBuZXcgRGF0ZSgpKTtcclxuICAgICAgY29uc29sZS5sb2coYOKchSBbTWVtb3J5TWFuYWdlcl0gQWdlbnQgbWVtb3J5IHVwZGF0ZWQgd2l0aCBsYXRlc3QgY29udmVyc2F0aW9uYCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGDinYwgW01lbW9yeU1hbmFnZXJdIEVycm9yIHVwZGF0aW5nIGFnZW50IG1lbW9yeTpgLCBlcnJvcik7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gRXhpdGluZyB1cGRhdGVBZ2VudE1lbW9yeSgpXCIpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGdldFJlbGV2YW50TWVtb3JpZXMoXHJcbiAgICBjb21wYW5pb25LZXk6IENvbXBhbmlvbktleSxcclxuICAgIHF1ZXJ5OiBzdHJpbmdcclxuICApOiBQcm9taXNlPHN0cmluZ1tdPiB7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+UpyBbREVCVUddIEVudGVyZWQgZ2V0UmVsZXZhbnRNZW1vcmllcygpIGZvciBrZXk6ICR7Y29tcGFuaW9uS2V5LmNvbXBhbmlvbklkfWApO1xyXG4gICAgY29uc29sZS5sb2coYPCfk50gW01lbW9yeU1hbmFnZXJdIFF1ZXJ5OiBcIiR7cXVlcnl9XCJgKTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBhZ2VudE1lbW9yeSA9IGF3YWl0IHRoaXMuZ2V0T3JDcmVhdGVBZ2VudE1lbW9yeShjb21wYW5pb25LZXkpO1xyXG4gICAgICBjb25zb2xlLmxvZyhg8J+noCBbTWVtb3J5TWFuYWdlcl0gUmV0cmlldmVkIGFnZW50IG1lbW9yeSBmb3IgY29tcGFuaW9uYCk7XHJcblxyXG4gICAgICBjb25zdCByZWxldmFudE1lbW9yaWVzID0gYXdhaXQgYWdlbnRNZW1vcnkubWVtb3J5UmV0cmlldmVyLmdldFJlbGV2YW50RG9jdW1lbnRzKFxyXG4gICAgICAgIHF1ZXJ5XHJcbiAgICAgICk7XHJcbiAgICAgIGNvbnNvbGUubG9nKFxyXG4gICAgICAgIGDinIUgW01lbW9yeU1hbmFnZXJdIFJldHJpZXZlZCAke3JlbGV2YW50TWVtb3JpZXMubGVuZ3RofSByZWxldmFudCBtZW1vcmllc2BcclxuICAgICAgKTtcclxuXHJcbiAgICAgIHJlbGV2YW50TWVtb3JpZXMuZm9yRWFjaCgobWVtLCBpbmRleCkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFxyXG4gICAgICAgICAgYPCfk44gW01lbW9yeU1hbmFnZXJdIE1lbW9yeSAke2luZGV4ICsgMX06IFwiJHttZW0ucGFnZUNvbnRlbnQuc3Vic3RyaW5nKDAsIDUwKX0uLi5cImBcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+UpyBbREVCVUddIEV4aXRpbmcgZ2V0UmVsZXZhbnRNZW1vcmllcygpXCIpO1xyXG4gICAgICByZXR1cm4gcmVsZXZhbnRNZW1vcmllcy5tYXAoKG1lbSkgPT4gbWVtLnBhZ2VDb250ZW50KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBbTWVtb3J5TWFuYWdlcl0gRXJyb3IgcmV0cmlldmluZyByZWxldmFudCBtZW1vcmllczpgLCBlcnJvcik7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+UpyBbREVCVUddIEV4aXRpbmcgZ2V0UmVsZXZhbnRNZW1vcmllcygpIHdpdGggZXJyb3JcIik7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyByZWFkTGF0ZXN0SGlzdG9yeShjb21wYW5pb25LZXk6IENvbXBhbmlvbktleSk6IFByb21pc2U8c3RyaW5nW10+IHtcclxuICAgIGNvbnNvbGUubG9nKGDwn5SnIFtERUJVR10gRW50ZXJlZCByZWFkTGF0ZXN0SGlzdG9yeSgpIGZvciBrZXk6ICR7Y29tcGFuaW9uS2V5LmNvbXBhbmlvbklkfWApO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2VzID0gYXdhaXQgdGhpcy5wcmlzbWEubWVzc2FnZS5maW5kTWFueSh7XHJcbiAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgIHVzZXJJZDogY29tcGFuaW9uS2V5LnVzZXJJZCxcclxuICAgICAgICAgIGNvbXBhbmlvbklkOiBjb21wYW5pb25LZXkuY29tcGFuaW9uSWQsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBvcmRlckJ5OiB7XHJcbiAgICAgICAgICBjcmVhdGVkQXQ6IFwiZGVzY1wiLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgdGFrZTogMzAsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coYOKchSBbTWVtb3J5TWFuYWdlcl0gUmV0cmlldmVkICR7bWVzc2FnZXMubGVuZ3RofSBtZXNzYWdlcyBmcm9tIGRhdGFiYXNlYCk7XHJcbiAgICAgIG1lc3NhZ2VzLmZvckVhY2goKG1zZywgaW5kZXgpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcclxuICAgICAgICAgIGDwn5OEIFtNZW1vcnlNYW5hZ2VyXSBNZXNzYWdlICR7aW5kZXggKyAxfTogXCIke21zZy5jb250ZW50LnN1YnN0cmluZygwLCA1MCl9Li4uXCJgXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhcIvCflKcgW0RFQlVHXSBFeGl0aW5nIHJlYWRMYXRlc3RIaXN0b3J5KClcIik7XHJcbiAgICAgIHJldHVybiBtZXNzYWdlcy5tYXAoKG1zZykgPT4gbXNnLmNvbnRlbnQpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihg4p2MIFtNZW1vcnlNYW5hZ2VyXSBFcnJvciByZXRyaWV2aW5nIGxhdGVzdCBoaXN0b3J5OmAsIGVycm9yKTtcclxuICAgICAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gRXhpdGluZyByZWFkTGF0ZXN0SGlzdG9yeSgpIHdpdGggZXJyb3JcIik7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzZWVkQ2hhdEhpc3RvcnkoXHJcbiAgICBzZWVkOiBzdHJpbmcsXHJcbiAgICBkZWxpbWl0ZXI6IHN0cmluZyxcclxuICAgIGNvbXBhbmlvbktleTogQ29tcGFuaW9uS2V5XHJcbiAgKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+UpyBbREVCVUddIEVudGVyZWQgc2VlZENoYXRIaXN0b3J5KCkgZm9yIGtleTogJHtjb21wYW5pb25LZXkuY29tcGFuaW9uSWR9YCk7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+MsSBbTWVtb3J5TWFuYWdlcl0gU2VlZCB0ZXh0IGxlbmd0aDogJHtzZWVkLmxlbmd0aH1gKTtcclxuXHJcbiAgICBjb25zdCBtZXNzYWdlcyA9IHNlZWQuc3BsaXQoZGVsaW1pdGVyKTtcclxuICAgIGNvbnNvbGUubG9nKGDwn5OKIFtNZW1vcnlNYW5hZ2VyXSBTZWVkaW5nICR7bWVzc2FnZXMubGVuZ3RofSBtZXNzYWdlc2ApO1xyXG5cclxuICAgIGZvciAoY29uc3QgbWVzc2FnZSBvZiBtZXNzYWdlcykge1xyXG4gICAgICBhd2FpdCB0aGlzLmFkZE1lbW9yeShjb21wYW5pb25LZXksIG1lc3NhZ2UpO1xyXG4gICAgICBjb25zb2xlLmxvZyhg4p6VIFtNZW1vcnlNYW5hZ2VyXSBTZWVkZWQgbWVzc2FnZTogXCIke21lc3NhZ2Uuc3Vic3RyaW5nKDAsIDUwKX0uLi5cImApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnNvbGUubG9nKGDinIUgW01lbW9yeU1hbmFnZXJdIENoYXQgaGlzdG9yeSBzZWVkaW5nIGNvbXBsZXRlZGApO1xyXG4gICAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gRXhpdGluZyBzZWVkQ2hhdEhpc3RvcnkoKVwiKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBjbGVhckhpc3RvcnkoY29tcGFuaW9uS2V5OiBDb21wYW5pb25LZXkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnNvbGUubG9nKGDwn5SnIFtERUJVR10gRW50ZXJlZCBjbGVhckhpc3RvcnkoKSBmb3Iga2V5OiAke2NvbXBhbmlvbktleS5jb21wYW5pb25JZH1gKTtcclxuXHJcbiAgICBpZiAoIWNvbXBhbmlvbktleS51c2VySWQpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihg4p2MIFtNZW1vcnlNYW5hZ2VyXSBDb21wYW5pb24ga2V5IHNldCBpbmNvcnJlY3RseWApO1xyXG4gICAgICBjb25zb2xlLmxvZyhcIvCflKcgW0RFQlVHXSBFeGl0aW5nIGNsZWFySGlzdG9yeSgpIGR1ZSB0byBpbnZhbGlkIGNvbXBhbmlvbktleVwiKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGRlbGV0ZVJlc3VsdCA9IGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2UuZGVsZXRlTWFueSh7XHJcbiAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgIHVzZXJJZDogY29tcGFuaW9uS2V5LnVzZXJJZCxcclxuICAgICAgICAgIGNvbXBhbmlvbklkOiBjb21wYW5pb25LZXkuY29tcGFuaW9uSWQsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDwn5eR77iPIFtNZW1vcnlNYW5hZ2VyXSBEZWxldGVkICR7ZGVsZXRlUmVzdWx0LmNvdW50fSBtZXNzYWdlcyBmcm9tIGRhdGFiYXNlYCk7XHJcblxyXG4gICAgICBjb25zdCBrZXkgPSBgJHtjb21wYW5pb25LZXkudXNlcklkfToke2NvbXBhbmlvbktleS5jb21wYW5pb25JZH1gO1xyXG4gICAgICB0aGlzLmFnZW50TWVtb3JpZXMuZGVsZXRlKGtleSk7XHJcbiAgICAgIHRoaXMuYnVmZmVyTWVtb3JpZXMuZGVsZXRlKGtleSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDwn6e5IFtNZW1vcnlNYW5hZ2VyXSBDbGVhcmVkIHZlY3RvciBzdG9yZSBhbmQgYnVmZmVyIG1lbW9yeSBmb3Iga2V5OiAke2tleX1gKTtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKGDinIUgW01lbW9yeU1hbmFnZXJdIENoYXQgaGlzdG9yeSBjbGVhcmVkIHN1Y2Nlc3NmdWxseWApO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihg4p2MIFtNZW1vcnlNYW5hZ2VyXSBFcnJvciBjbGVhcmluZyBjaGF0IGhpc3Rvcnk6YCwgZXJyb3IpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnNvbGUubG9nKFwi8J+UpyBbREVCVUddIEV4aXRpbmcgY2xlYXJIaXN0b3J5KClcIik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZ2V0TWVtb3J5TWFuYWdlcihcclxuICAgIGNvbXBhbmlvbktleTogQ29tcGFuaW9uS2V5XHJcbiAgKTogUHJvbWlzZTx7IGJ1ZmZlck1lbW9yeTogQnVmZmVyTWVtb3J5IH0+IHtcclxuICAgIGNvbnNvbGUubG9nKGDwn5SnIFtERUJVR10gRW50ZXJlZCBnZXRNZW1vcnlNYW5hZ2VyKCkgZm9yIGtleTogJHtjb21wYW5pb25LZXkuY29tcGFuaW9uSWR9YCk7XHJcbiAgICBjb25zdCBidWZmZXJNZW1vcnkgPSB0aGlzLmdldE9yQ3JlYXRlQnVmZmVyTWVtb3J5KGNvbXBhbmlvbktleSk7XHJcbiAgICBjb25zb2xlLmxvZyhg4pyFIFtNZW1vcnlNYW5hZ2VyXSBCdWZmZXJNZW1vcnkgcmV0cmlldmVkIGZvciBrZXk6ICR7Y29tcGFuaW9uS2V5LmNvbXBhbmlvbklkfWApO1xyXG4gICAgY29uc29sZS5sb2coXCLwn5SnIFtERUJVR10gRXhpdGluZyBnZXRNZW1vcnlNYW5hZ2VyKClcIik7XHJcbiAgICByZXR1cm4geyBidWZmZXJNZW1vcnkgfTtcclxuICB9XHJcbn1cclxuIl0sIm5hbWVzIjpbIlByaXNtYUNsaWVudCIsIkZhaXNzU3RvcmUiLCJPcGVuQUlFbWJlZGRpbmdzIiwiR2VuZXJhdGl2ZUFnZW50TWVtb3J5IiwiVGltZVdlaWdodGVkVmVjdG9yU3RvcmVSZXRyaWV2ZXIiLCJDaGF0T3BlbkFJIiwiQnVmZmVyTWVtb3J5IiwiTWVtb3J5TWFuYWdlciIsImFnZW50TWVtb3JpZXMiLCJNYXAiLCJidWZmZXJNZW1vcmllcyIsImNvbnNvbGUiLCJsb2ciLCJwcmlzbWEiLCJnZXRJbnN0YW5jZSIsImluc3RhbmNlIiwiZ2V0T3JDcmVhdGVBZ2VudE1lbW9yeSIsImNvbXBhbmlvbktleSIsImtleSIsInVzZXJJZCIsImNvbXBhbmlvbklkIiwiaGFzIiwicHJvY2VzcyIsImVudiIsIk9QRU5BSV9BUElfS0VZIiwiZXJyb3IiLCJFcnJvciIsImxsbSIsIm1vZGVsTmFtZSIsInRlbXBlcmF0dXJlIiwib3BlbkFJQXBpS2V5IiwiZW1iZWRkaW5ncyIsImFwaUtleSIsInByZXZpb3VzTWVzc2FnZXMiLCJyZWFkTGF0ZXN0SGlzdG9yeSIsImxlbmd0aCIsImluaXRpYWxUZXh0cyIsInZlY3RvclN0b3JlIiwiZnJvbVRleHRzIiwibWFwIiwiXyIsImlkeCIsImlkIiwibWVtb3J5UmV0cmlldmVyIiwib3RoZXJTY29yZUtleXMiLCJrIiwiYWdlbnRNZW1vcnkiLCJyZWZsZWN0aW9uVGhyZXNob2xkIiwiaW1wb3J0YW5jZVdlaWdodCIsInZlcmJvc2UiLCJtYXhUb2tlbnNMaW1pdCIsInNldCIsImdldCIsImdldE9yQ3JlYXRlQnVmZmVyTWVtb3J5IiwiYnVmZmVyTWVtb3J5IiwicmV0dXJuTWVzc2FnZXMiLCJtZW1vcnlLZXkiLCJhZGRNZW1vcnkiLCJ0ZXh0Iiwic3Vic3RyaW5nIiwiRGF0ZSIsIm1lc3NhZ2UiLCJjcmVhdGUiLCJkYXRhIiwiY29udGVudCIsInJvbGUiLCJ1cGRhdGVBZ2VudE1lbW9yeSIsInVzZXJJbnB1dCIsImFpUmVzcG9uc2UiLCJnZXRSZWxldmFudE1lbW9yaWVzIiwicXVlcnkiLCJyZWxldmFudE1lbW9yaWVzIiwiZ2V0UmVsZXZhbnREb2N1bWVudHMiLCJmb3JFYWNoIiwibWVtIiwiaW5kZXgiLCJwYWdlQ29udGVudCIsIm1lc3NhZ2VzIiwiZmluZE1hbnkiLCJ3aGVyZSIsIm9yZGVyQnkiLCJjcmVhdGVkQXQiLCJ0YWtlIiwibXNnIiwic2VlZENoYXRIaXN0b3J5Iiwic2VlZCIsImRlbGltaXRlciIsInNwbGl0IiwiY2xlYXJIaXN0b3J5IiwiZGVsZXRlUmVzdWx0IiwiZGVsZXRlTWFueSIsImNvdW50IiwiZGVsZXRlIiwiZ2V0TWVtb3J5TWFuYWdlciJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/memory.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/prismadb.ts":
/*!*****************************!*\
  !*** ./src/lib/prismadb.ts ***!
  \*****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__)\n/* harmony export */ });\n/* harmony import */ var _prisma_client__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @prisma/client */ \"@prisma/client\");\n/* harmony import */ var _prisma_client__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(_prisma_client__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _prisma_extension_accelerate__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @prisma/extension-accelerate */ \"(rsc)/./node_modules/@prisma/extension-accelerate/dist/esm/entry.node.js\");\n/* harmony import */ var dotenv__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! dotenv */ \"(rsc)/./node_modules/dotenv/lib/main.js\");\n/* harmony import */ var dotenv__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(dotenv__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var path__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! path */ \"path\");\n/* harmony import */ var path__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(path__WEBPACK_IMPORTED_MODULE_3__);\n// src/lib/prismadb.ts\n\n\n\n\n// Load the .env.local file\ndotenv__WEBPACK_IMPORTED_MODULE_2___default().config({\n    path: path__WEBPACK_IMPORTED_MODULE_3___default().resolve(__dirname, \"../../.env.local\")\n});\nconst prismaClientSingleton = ()=>{\n    return new _prisma_client__WEBPACK_IMPORTED_MODULE_0__.PrismaClient().$extends((0,_prisma_extension_accelerate__WEBPACK_IMPORTED_MODULE_1__.withAccelerate)());\n};\nconst prisma = global.prismaGlobal ?? prismaClientSingleton();\nif (true) global.prismaGlobal = prisma;\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (prisma);\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL3ByaXNtYWRiLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsc0JBQXNCO0FBRXdCO0FBQ2dCO0FBQ2xDO0FBQ0o7QUFFeEIsMkJBQTJCO0FBQzNCRSxvREFBYSxDQUFDO0lBQUVDLE1BQU1BLG1EQUFZLENBQUNHLFdBQVc7QUFBb0I7QUFFbEUsTUFBTUMsd0JBQXdCO0lBQzVCLE9BQU8sSUFBSVAsd0RBQVlBLEdBQUdRLFFBQVEsQ0FBQ1AsNEVBQWNBO0FBQ25EO0FBT0EsTUFBTVEsU0FBU0MsT0FBT0MsWUFBWSxJQUFJSjtBQUV0QyxJQUFJSyxJQUF5QixFQUFjRixPQUFPQyxZQUFZLEdBQUdGO0FBRWpFLGlFQUFlQSxNQUFNQSxFQUFDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vYWktY29tcGFuaW9uLy4vc3JjL2xpYi9wcmlzbWFkYi50cz85ZmVjIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9saWIvcHJpc21hZGIudHNcclxuXHJcbmltcG9ydCB7IFByaXNtYUNsaWVudCB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcclxuaW1wb3J0IHsgd2l0aEFjY2VsZXJhdGUgfSBmcm9tICdAcHJpc21hL2V4dGVuc2lvbi1hY2NlbGVyYXRlJztcclxuaW1wb3J0IGRvdGVudiBmcm9tICdkb3RlbnYnO1xyXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuXHJcbi8vIExvYWQgdGhlIC5lbnYubG9jYWwgZmlsZVxyXG5kb3RlbnYuY29uZmlnKHsgcGF0aDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uLy4uLy5lbnYubG9jYWwnKSB9KTtcclxuXHJcbmNvbnN0IHByaXNtYUNsaWVudFNpbmdsZXRvbiA9ICgpID0+IHtcclxuICByZXR1cm4gbmV3IFByaXNtYUNsaWVudCgpLiRleHRlbmRzKHdpdGhBY2NlbGVyYXRlKCkpO1xyXG59XHJcblxyXG5kZWNsYXJlIGdsb2JhbCB7XHJcbiAgLy8gRXh0ZW5kaW5nIHRoZSBOb2RlSlMgZ2xvYmFsIGludGVyZmFjZVxyXG4gIHZhciBwcmlzbWFHbG9iYWw6IFJldHVyblR5cGU8dHlwZW9mIHByaXNtYUNsaWVudFNpbmdsZXRvbj4gfCB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbmNvbnN0IHByaXNtYSA9IGdsb2JhbC5wcmlzbWFHbG9iYWwgPz8gcHJpc21hQ2xpZW50U2luZ2xldG9uKCk7XHJcblxyXG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgZ2xvYmFsLnByaXNtYUdsb2JhbCA9IHByaXNtYTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHByaXNtYTtcclxuIl0sIm5hbWVzIjpbIlByaXNtYUNsaWVudCIsIndpdGhBY2NlbGVyYXRlIiwiZG90ZW52IiwicGF0aCIsImNvbmZpZyIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJwcmlzbWFDbGllbnRTaW5nbGV0b24iLCIkZXh0ZW5kcyIsInByaXNtYSIsImdsb2JhbCIsInByaXNtYUdsb2JhbCIsInByb2Nlc3MiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/prismadb.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/rate-limit.ts":
/*!*******************************!*\
  !*** ./src/lib/rate-limit.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   checkApiLimit: () => (/* binding */ checkApiLimit),\n/* harmony export */   getApiLimitCount: () => (/* binding */ getApiLimitCount),\n/* harmony export */   increaseApiLimit: () => (/* binding */ increaseApiLimit),\n/* harmony export */   rateLimit: () => (/* binding */ rateLimit)\n/* harmony export */ });\n/* harmony import */ var _clerk_nextjs_server__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @clerk/nextjs/server */ \"(rsc)/./node_modules/@clerk/nextjs/dist/esm/server/createGetAuth.js\");\n/* harmony import */ var _prismadb__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./prismadb */ \"(rsc)/./src/lib/prismadb.ts\");\n//C:\\AI_src\\Companion_UI\\SaaS-AI-Companion\\src\\lib\\rate-limit.ts\n\n\nconst MAX_FREE_COUNTS = parseInt(process.env.MAX_FREE_COUNTS || \"1000\", 10);\nconst increaseApiLimit = async (req)=>{\n    const { userId } = (0,_clerk_nextjs_server__WEBPACK_IMPORTED_MODULE_1__.getAuth)(req);\n    if (!userId) {\n        return;\n    }\n    try {\n        const userApiLimit = await _prismadb__WEBPACK_IMPORTED_MODULE_0__[\"default\"].userApiLimit.findUnique({\n            where: {\n                userId\n            }\n        });\n        if (userApiLimit) {\n            await _prismadb__WEBPACK_IMPORTED_MODULE_0__[\"default\"].userApiLimit.update({\n                where: {\n                    userId\n                },\n                data: {\n                    count: userApiLimit.count + 1\n                }\n            });\n        } else {\n            await _prismadb__WEBPACK_IMPORTED_MODULE_0__[\"default\"].userApiLimit.create({\n                data: {\n                    userId,\n                    count: 1\n                }\n            });\n        }\n    } catch (error) {\n        console.error(\"Error increasing API limit:\", error);\n    }\n};\nconst checkApiLimit = async (req)=>{\n    const { userId } = (0,_clerk_nextjs_server__WEBPACK_IMPORTED_MODULE_1__.getAuth)(req);\n    if (!userId) {\n        return false;\n    }\n    try {\n        const userApiLimit = await _prismadb__WEBPACK_IMPORTED_MODULE_0__[\"default\"].userApiLimit.findUnique({\n            where: {\n                userId\n            }\n        });\n        return !userApiLimit || userApiLimit.count < MAX_FREE_COUNTS;\n    } catch (error) {\n        console.error(\"Error checking API limit:\", error);\n        return false;\n    }\n};\nconst getApiLimitCount = async (req)=>{\n    const { userId } = (0,_clerk_nextjs_server__WEBPACK_IMPORTED_MODULE_1__.getAuth)(req);\n    if (!userId) {\n        return 0;\n    }\n    try {\n        const userApiLimit = await _prismadb__WEBPACK_IMPORTED_MODULE_0__[\"default\"].userApiLimit.findUnique({\n            where: {\n                userId\n            }\n        });\n        return userApiLimit ? userApiLimit.count : 0;\n    } catch (error) {\n        console.error(\"Error getting API limit count:\", error);\n        return 0;\n    }\n};\n// Add this function\nconst rateLimit = async (req)=>{\n    const isWithinLimit = await checkApiLimit(req);\n    if (isWithinLimit) {\n        await increaseApiLimit(req);\n        return {\n            success: true\n        };\n    } else {\n        return {\n            success: false\n        };\n    }\n};\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL3JhdGUtbGltaXQudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsZ0VBQWdFO0FBRWpCO0FBQ2I7QUFHbEMsTUFBTUUsa0JBQWtCQyxTQUFTQyxRQUFRQyxHQUFHLENBQUNILGVBQWUsSUFBSSxRQUFRO0FBRWpFLE1BQU1JLG1CQUFtQixPQUFPQztJQUNyQyxNQUFNLEVBQUVDLE1BQU0sRUFBRSxHQUFHUiw2REFBT0EsQ0FBQ087SUFFM0IsSUFBSSxDQUFDQyxRQUFRO1FBQ1g7SUFDRjtJQUVBLElBQUk7UUFDRixNQUFNQyxlQUFlLE1BQU1SLGlEQUFRQSxDQUFDUSxZQUFZLENBQUNDLFVBQVUsQ0FBQztZQUMxREMsT0FBTztnQkFBRUg7WUFBTztRQUNsQjtRQUVBLElBQUlDLGNBQWM7WUFDaEIsTUFBTVIsaURBQVFBLENBQUNRLFlBQVksQ0FBQ0csTUFBTSxDQUFDO2dCQUNqQ0QsT0FBTztvQkFBRUg7Z0JBQU87Z0JBQ2hCSyxNQUFNO29CQUFFQyxPQUFPTCxhQUFhSyxLQUFLLEdBQUc7Z0JBQUU7WUFDeEM7UUFDRixPQUFPO1lBQ0wsTUFBTWIsaURBQVFBLENBQUNRLFlBQVksQ0FBQ00sTUFBTSxDQUFDO2dCQUNqQ0YsTUFBTTtvQkFBRUw7b0JBQVFNLE9BQU87Z0JBQUU7WUFDM0I7UUFDRjtJQUNGLEVBQUUsT0FBT0UsT0FBTztRQUNkQyxRQUFRRCxLQUFLLENBQUMsK0JBQStCQTtJQUMvQztBQUNGLEVBQUU7QUFFSyxNQUFNRSxnQkFBZ0IsT0FBT1g7SUFDbEMsTUFBTSxFQUFFQyxNQUFNLEVBQUUsR0FBR1IsNkRBQU9BLENBQUNPO0lBRTNCLElBQUksQ0FBQ0MsUUFBUTtRQUNYLE9BQU87SUFDVDtJQUVBLElBQUk7UUFDRixNQUFNQyxlQUFlLE1BQU1SLGlEQUFRQSxDQUFDUSxZQUFZLENBQUNDLFVBQVUsQ0FBQztZQUMxREMsT0FBTztnQkFBRUg7WUFBTztRQUNsQjtRQUVBLE9BQU8sQ0FBQ0MsZ0JBQWdCQSxhQUFhSyxLQUFLLEdBQUdaO0lBQy9DLEVBQUUsT0FBT2MsT0FBTztRQUNkQyxRQUFRRCxLQUFLLENBQUMsNkJBQTZCQTtRQUMzQyxPQUFPO0lBQ1Q7QUFDRixFQUFFO0FBRUssTUFBTUcsbUJBQW1CLE9BQU9aO0lBQ3JDLE1BQU0sRUFBRUMsTUFBTSxFQUFFLEdBQUdSLDZEQUFPQSxDQUFDTztJQUUzQixJQUFJLENBQUNDLFFBQVE7UUFDWCxPQUFPO0lBQ1Q7SUFFQSxJQUFJO1FBQ0YsTUFBTUMsZUFBZSxNQUFNUixpREFBUUEsQ0FBQ1EsWUFBWSxDQUFDQyxVQUFVLENBQUM7WUFDMURDLE9BQU87Z0JBQUVIO1lBQU87UUFDbEI7UUFFQSxPQUFPQyxlQUFlQSxhQUFhSyxLQUFLLEdBQUc7SUFDN0MsRUFBRSxPQUFPRSxPQUFPO1FBQ2RDLFFBQVFELEtBQUssQ0FBQyxrQ0FBa0NBO1FBQ2hELE9BQU87SUFDVDtBQUNGLEVBQUU7QUFFRixvQkFBb0I7QUFDYixNQUFNSSxZQUFZLE9BQU9iO0lBQzlCLE1BQU1jLGdCQUFnQixNQUFNSCxjQUFjWDtJQUMxQyxJQUFJYyxlQUFlO1FBQ2pCLE1BQU1mLGlCQUFpQkM7UUFDdkIsT0FBTztZQUFFZSxTQUFTO1FBQUs7SUFDekIsT0FBTztRQUNMLE9BQU87WUFBRUEsU0FBUztRQUFNO0lBQzFCO0FBQ0YsRUFBRSIsInNvdXJjZXMiOlsid2VicGFjazovL2FpLWNvbXBhbmlvbi8uL3NyYy9saWIvcmF0ZS1saW1pdC50cz84Yzc3Il0sInNvdXJjZXNDb250ZW50IjpbIi8vQzpcXEFJX3NyY1xcQ29tcGFuaW9uX1VJXFxTYWFTLUFJLUNvbXBhbmlvblxcc3JjXFxsaWJcXHJhdGUtbGltaXQudHNcclxuXHJcbmltcG9ydCB7IGdldEF1dGggfSBmcm9tIFwiQGNsZXJrL25leHRqcy9zZXJ2ZXJcIjtcclxuaW1wb3J0IHByaXNtYWRiIGZyb20gXCIuL3ByaXNtYWRiXCI7XHJcbmltcG9ydCB0eXBlIHsgTmV4dFJlcXVlc3QgfSBmcm9tIFwibmV4dC9zZXJ2ZXJcIjtcclxuXHJcbmNvbnN0IE1BWF9GUkVFX0NPVU5UUyA9IHBhcnNlSW50KHByb2Nlc3MuZW52Lk1BWF9GUkVFX0NPVU5UUyB8fCBcIjEwMDBcIiwgMTApO1xyXG5cclxuZXhwb3J0IGNvbnN0IGluY3JlYXNlQXBpTGltaXQgPSBhc3luYyAocmVxOiBOZXh0UmVxdWVzdCk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gIGNvbnN0IHsgdXNlcklkIH0gPSBnZXRBdXRoKHJlcSk7XHJcblxyXG4gIGlmICghdXNlcklkKSB7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICB0cnkge1xyXG4gICAgY29uc3QgdXNlckFwaUxpbWl0ID0gYXdhaXQgcHJpc21hZGIudXNlckFwaUxpbWl0LmZpbmRVbmlxdWUoe1xyXG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmICh1c2VyQXBpTGltaXQpIHtcclxuICAgICAgYXdhaXQgcHJpc21hZGIudXNlckFwaUxpbWl0LnVwZGF0ZSh7XHJcbiAgICAgICAgd2hlcmU6IHsgdXNlcklkIH0sXHJcbiAgICAgICAgZGF0YTogeyBjb3VudDogdXNlckFwaUxpbWl0LmNvdW50ICsgMSB9LFxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGF3YWl0IHByaXNtYWRiLnVzZXJBcGlMaW1pdC5jcmVhdGUoe1xyXG4gICAgICAgIGRhdGE6IHsgdXNlcklkLCBjb3VudDogMSB9LFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIGluY3JlYXNpbmcgQVBJIGxpbWl0OlwiLCBlcnJvcik7XHJcbiAgfVxyXG59O1xyXG5cclxuZXhwb3J0IGNvbnN0IGNoZWNrQXBpTGltaXQgPSBhc3luYyAocmVxOiBOZXh0UmVxdWVzdCk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xyXG4gIGNvbnN0IHsgdXNlcklkIH0gPSBnZXRBdXRoKHJlcSk7XHJcblxyXG4gIGlmICghdXNlcklkKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICB0cnkge1xyXG4gICAgY29uc3QgdXNlckFwaUxpbWl0ID0gYXdhaXQgcHJpc21hZGIudXNlckFwaUxpbWl0LmZpbmRVbmlxdWUoe1xyXG4gICAgICB3aGVyZTogeyB1c2VySWQgfSxcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiAhdXNlckFwaUxpbWl0IHx8IHVzZXJBcGlMaW1pdC5jb3VudCA8IE1BWF9GUkVFX0NPVU5UUztcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIGNoZWNraW5nIEFQSSBsaW1pdDpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBnZXRBcGlMaW1pdENvdW50ID0gYXN5bmMgKHJlcTogTmV4dFJlcXVlc3QpOiBQcm9taXNlPG51bWJlcj4gPT4ge1xyXG4gIGNvbnN0IHsgdXNlcklkIH0gPSBnZXRBdXRoKHJlcSk7XHJcblxyXG4gIGlmICghdXNlcklkKSB7XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcblxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB1c2VyQXBpTGltaXQgPSBhd2FpdCBwcmlzbWFkYi51c2VyQXBpTGltaXQuZmluZFVuaXF1ZSh7XHJcbiAgICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHVzZXJBcGlMaW1pdCA/IHVzZXJBcGlMaW1pdC5jb3VudCA6IDA7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBnZXR0aW5nIEFQSSBsaW1pdCBjb3VudDpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIDA7XHJcbiAgfVxyXG59O1xyXG5cclxuLy8gQWRkIHRoaXMgZnVuY3Rpb25cclxuZXhwb3J0IGNvbnN0IHJhdGVMaW1pdCA9IGFzeW5jIChyZXE6IE5leHRSZXF1ZXN0KSA9PiB7XHJcbiAgY29uc3QgaXNXaXRoaW5MaW1pdCA9IGF3YWl0IGNoZWNrQXBpTGltaXQocmVxKTtcclxuICBpZiAoaXNXaXRoaW5MaW1pdCkge1xyXG4gICAgYXdhaXQgaW5jcmVhc2VBcGlMaW1pdChyZXEpO1xyXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9O1xyXG4gIH1cclxufTtcclxuIl0sIm5hbWVzIjpbImdldEF1dGgiLCJwcmlzbWFkYiIsIk1BWF9GUkVFX0NPVU5UUyIsInBhcnNlSW50IiwicHJvY2VzcyIsImVudiIsImluY3JlYXNlQXBpTGltaXQiLCJyZXEiLCJ1c2VySWQiLCJ1c2VyQXBpTGltaXQiLCJmaW5kVW5pcXVlIiwid2hlcmUiLCJ1cGRhdGUiLCJkYXRhIiwiY291bnQiLCJjcmVhdGUiLCJlcnJvciIsImNvbnNvbGUiLCJjaGVja0FwaUxpbWl0IiwiZ2V0QXBpTGltaXRDb3VudCIsInJhdGVMaW1pdCIsImlzV2l0aGluTGltaXQiLCJzdWNjZXNzIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/rate-limit.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@clerk","vendor-chunks/crypto-js","vendor-chunks/tslib","vendor-chunks/@prisma","vendor-chunks/dotenv","vendor-chunks/ms","vendor-chunks/cookie","vendor-chunks/map-obj","vendor-chunks/no-case","vendor-chunks/lower-case","vendor-chunks/snakecase-keys","vendor-chunks/snake-case","vendor-chunks/dot-case","vendor-chunks/formdata-node","vendor-chunks/@langchain","vendor-chunks/langchain","vendor-chunks/openai","vendor-chunks/semver","vendor-chunks/zod-to-json-schema","vendor-chunks/langsmith","vendor-chunks/form-data-encoder","vendor-chunks/uuid","vendor-chunks/whatwg-url","vendor-chunks/agentkeepalive","vendor-chunks/retry","vendor-chunks/p-queue","vendor-chunks/js-tiktoken","vendor-chunks/tr46","vendor-chunks/zod","vendor-chunks/node-fetch","vendor-chunks/mustache","vendor-chunks/js-yaml","vendor-chunks/webidl-conversions","vendor-chunks/web-streams-polyfill","vendor-chunks/p-timeout","vendor-chunks/p-retry","vendor-chunks/p-finally","vendor-chunks/humanize-ms","vendor-chunks/eventemitter3","vendor-chunks/event-target-shim","vendor-chunks/decamelize","vendor-chunks/camelcase","vendor-chunks/base64-js","vendor-chunks/ansi-styles","vendor-chunks/abort-controller"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2F%5BchatId%5D%2Froute&page=%2Fapi%2Fchat%2F%5BchatId%5D%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2F%5BchatId%5D%2Froute.ts&appDir=C%3A%5CAI_src%5CCompanion_UI%5CSaaS-AI-Companion%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CAI_src%5CCompanion_UI%5CSaaS-AI-Companion&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();